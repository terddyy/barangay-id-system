<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Digital ID E-Services (Core A)</title>

  <!-- Stylesheets -->
  <link rel="stylesheet" href="assets/coreA.css">
  <link rel="stylesheet" href="assets/responsive.css">

  <!-- Data Service Layer (Clean Architecture - SQLite Backend) -->
  <script src="dataService.js"></script>
  
  <!-- Legacy API Client (for backward compatibility) -->
  <script src="apisClient.js"></script>

  <!-- Session Guard: block if not logged in -->
  <script>
    const token = localStorage.getItem("token");
    const userRawCheck = localStorage.getItem("user");
    if (!token || !userRawCheck) {
      window.location.href = "index.html";
    }
  </script>
</head>

<body>
  <!-- ===== TOP BAR / HEADER ===== -->
 

  <!-- ===== ROLE / SESSION SCRIPT ===== -->
  <script>
    function logout() {
      localStorage.removeItem("token");
      localStorage.removeItem("user");
      window.location.href = "index.html";
    }

    document.addEventListener("DOMContentLoaded", () => {
      // get user from storage
      const userRaw = localStorage.getItem("user");
      
      if (!userRaw) {
        window.location.href = "index.html";
        return;
      }

      let user;
      try {
        user = JSON.parse(userRaw); // {username, email, role, ...}
      } catch {
        window.location.href = "index.html";
        return;
      }

      // Update header UI with user info
      const roleBadge = document.getElementById("roleBadge");
      const btnLogin = document.getElementById("btnLogin");
      const btnLogout = document.getElementById("btnLogout");
      const authUserInfo = document.getElementById("authUserInfo");
      const currentUserName = document.getElementById("currentUserName");
      const currentUserRole = document.getElementById("currentUserRole");

      // Show user info
      if (currentUserName) {
        currentUserName.textContent = user.username || user.email || "User";
      }
      if (currentUserRole) {
        currentUserRole.textContent = user.role ? user.role.charAt(0).toUpperCase() + user.role.slice(1) : "Staff";
      }
      
      // Update role badge
      if (roleBadge) {
        roleBadge.textContent = user.role ? user.role.toUpperCase() : "SIGNED-IN";
        roleBadge.className = "status-badge " + (user.role === "admin" ? "badge-admin" : "badge-staff");
      }

      // Show/hide auth buttons
      if (authUserInfo) authUserInfo.style.display = "flex";
      if (btnLogin) btnLogin.classList.add("hidden");
      if (btnLogout) btnLogout.classList.remove("hidden");

      // hide admin-only if not admin
      if (user.role !== "admin") {
        document.querySelectorAll(".admin-only").forEach(el => {
          el.style.display = "none";
        });
      }
    });
  </script>

  <!-- ===== CONTINUE WITH REST OF YOUR PAGE BELOW (dashboard cards, etc) ===== -->



  <!-- System meta (for audit / agency use) -->
  <meta name="application-name" content="Digital ID E-Services Core A">
  <meta name="author" content="Local Government Unit / Barangay">
  <meta name="description" content="Barangay Digital ID Enrollment, PVC ID Printing, and E-Docs Management">

  <!-- QR & BARCODE libs -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.6/dist/JsBarcode.all.min.js"></script>

  <!-- Face API (for AI Human Face Detection & Match) -->
  <script defer src="https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/dist/face-api.min.js"></script>

  <!-- NOTE:
    We'll split real CSS and JS into separate files later.
    Right now we keep inline style + one <script> so your app still runs standalone.
  -->
  <style>
    :root{
      --primary:#2563eb;
      --bg:#f6f7fb;
      --ink:#0f172a;
      --card:#fff;
      --muted:#6b7280;
      --ok:#16a34a;
      --bad:#dc2626;
      --amber:#d97706;
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      background:var(--bg);
      color:var(--ink);
      line-height:1.4;
    }

    .container{max-width:1200px;margin:0 auto;padding:16px}

    /* Header */
    header{
      background:var(--card);
      box-shadow:0 8px 24px rgba(0,0,0,.06);
      position:sticky;
      top:0;
      z-index:10;
    }
    header .row{display:flex;align-items:center;gap:16px;flex-wrap:wrap}

    /* Header top row layout */
    .header-top-row{
      display:flex;
      align-items:center;
      gap:16px;
      flex-wrap:wrap;
      justify-content:space-between;
    }

    /* Hamburger button - hidden on desktop */
    .hamburger-btn{
      display:none;
    }

    .masthead-left{
      display:flex;
      align-items:flex-start;
      gap:12px;
      flex-wrap:wrap;
      flex:1;
    }
    .masthead-text{
      display:flex;
      flex-direction:column;
      line-height:1.2;
    }
    .masthead-system-name{
      font-size:18px;
      font-weight:600;
      color:var(--ink);
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      align-items:center;
    }
    .masthead-agency{
      font-size:12px;
      color:var(--muted);
      font-weight:500;
    }

    .header-auth-buttons{
      display:flex;
      align-items:center;
      gap:8px;
    }

    .user-session{
      display:flex;
      align-items:center;
      flex-wrap:wrap;
      gap:12px;
      margin-left:auto;
    }

    /* Navigation wrapper */
    .nav-wrapper{
      border-top:1px solid #e5e7eb;
      padding-top:12px;
      margin-top:8px;
    }

    nav{
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      padding-bottom:8px;
    }
    nav button{
      padding:10px 14px;
      border:0;
      border-radius:10px;
      background:#e5e7eb;
      color:#111827;
      cursor:pointer;
      font-weight:600;
    }
    nav button.active{
      background:var(--primary);
      color:#fff;
    }

    main{padding-top:16px}
    .grid{display:grid;grid-template-columns:repeat(12,1fr);gap:16px}
    .card{
      background:var(--card);
      border-radius:16px;
      box-shadow:0 12px 30px rgba(0,0,0,.06);
      padding:16px;
    }
    .span-3{grid-column:span 3}
    .span-4{grid-column:span 4}
    .span-6{grid-column:span 6}
    .span-8{grid-column:span 8}
    .span-9{grid-column:span 9}
    .span-12{grid-column:span 12}

    h1,h2,h3,h4,h5,h6{margin:0;color:var(--ink)}
    h1{font-size:22px;font-weight:600}
    h2{font-size:16px;font-weight:600;margin:0 0 8px}

    .section-header{
      display:flex;
      justify-content:space-between;
      align-items:flex-start;
      flex-wrap:wrap;
      margin-bottom:12px;
    }
    .section-title-block{
      display:flex;
      flex-direction:column;
      gap:4px;
      max-width:100%;
    }
    .section-eyebrow{
      font-size:12px;
      font-weight:500;
      color:var(--muted);
      text-transform:uppercase;
      letter-spacing:.03em;
    }
    .section-title{
      font-size:16px;
      font-weight:600;
      color:var(--ink);
    }
    .section-desc{
      font-size:13px;
      color:var(--muted);
      line-height:1.4;
      max-width:680px;
    }

    label{display:block;font-size:14px;color:var(--muted);margin:8px 0 4px}
    input,select,textarea{
      width:100%;
      padding:10px 12px;
      border:1px solid #e5e7eb;
      border-radius:10px;
      font-size:14px;
      background-color:#fff;
      color:var(--ink);
    }
    textarea{min-height:90px}

    .row{display:flex;gap:12px;flex-wrap:wrap}
    .right{justify-content:flex-end}
    .center{justify-content:center}

    .btn{
      padding:10px 16px;
      border:0;
      border-radius:10px;
      background:var(--primary);
      color:#fff;
      font-weight:700;
      cursor:pointer;
      font-size:14px;
      line-height:1.2;
    }
    .btn.secondary{background:#e5e7eb;color:#111827}
    .btn.ghost{background:transparent;border:1px solid #e5e7eb;color:#111827}

    .tag{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      gap:6px;
      font-weight:600;
      border-radius:999px;
      padding:4px 10px;
      font-size:12px;
      line-height:1.2;
    }
    .tag.red{background:#fee2e2;color:#991b1b}
    .tag.green{background:#dcfce7;color:#14532d}
    .tag.amber{background:#fef3c7;color:#92400e}

    table{width:100%;border-collapse:collapse}
    th,td{
      padding:10px;
      border-bottom:1px solid #eee;
      font-size:14px;
      text-align:left;
      vertical-align:top;
    }
    th{
      font-weight:600;
      color:var(--ink);
      font-size:13px;
      text-transform:uppercase;
      letter-spacing:.03em
    }

    .pill{
      padding:6px 10px;
      border-radius:999px;
      border:1px solid #e5e7eb;
      background:#fff;
      font-size:14px;
      min-width:160px;
    }

    .muted{color:var(--muted)}
    .mb8{margin-bottom:8px}
    .mb16{margin-bottom:16px}
    .hidden{display:none!important}

    /* Editable fields styling */
    .editable-field {
      outline: none;
      border: 1px dashed transparent;
      border-radius: 3px;
      padding: 1px 3px;
      transition: all 0.2s ease;
      cursor: default;
    }
    .editable-field.edit-enabled {
      cursor: text;
    }
    .editable-field.edit-enabled:hover {
      border-color: #4f46e5;
      background-color: rgba(79, 70, 229, 0.05);
    }
    .editable-field.edit-enabled:focus {
      border-color: #4f46e5;
      background-color: rgba(79, 70, 229, 0.1);
      box-shadow: 0 0 3px rgba(79, 70, 229, 0.3);
    }
    .editable-field:empty:before {
      content: attr(data-placeholder);
      color: #999;
      font-style: italic;
    }

    /* Photo and Signature Edit Overlays */
    .front-photo {
      position: relative;
    }
    .photo-edit-overlay {
      position: absolute;
      top: 5px;
      right: 5px;
      display: flex;
      gap: 4px;
      opacity: 0;
      transition: opacity 0.2s ease;
    }
    .front-photo:hover .photo-edit-overlay {
      opacity: 1;
    }
    .photo-edit-btn {
      background: rgba(79, 70, 229, 0.9);
      border: none;
      border-radius: 4px;
      width: 24px;
      height: 24px;
      font-size: 12px;
      cursor: pointer;
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: background 0.2s ease;
    }
    .photo-edit-btn:hover {
      background: rgba(79, 70, 229, 1);
    }

    .front-signature-wrapper {
      position: relative;
    }
    .signature-edit-overlay {
      position: absolute;
      top: 2px;
      right: 2px;
      display: flex;
      gap: 3px;
      opacity: 0;
      transition: opacity 0.2s ease;
    }
    .front-signature-wrapper:hover .signature-edit-overlay {
      opacity: 1;
    }
    .signature-edit-btn {
      background: rgba(79, 70, 229, 0.9);
      border: none;
      border-radius: 3px;
      width: 20px;
      height: 20px;
      font-size: 10px;
      cursor: pointer;
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: background 0.2s ease;
    }
    .signature-edit-btn:hover {
      background: rgba(79, 70, 229, 1);
    }

    .back-sig-captain .captain-signature-line {
      position: relative;
    }
    .chairwoman-edit-overlay {
      position: absolute;
      top: 2px;
      right: 2px;
      display: flex;
      gap: 3px;
      opacity: 0;
      transition: opacity 0.2s ease;
    }
    .back-sig-captain:hover .chairwoman-edit-overlay {
      opacity: 1;
    }
    .chairwoman-edit-btn {
      background: rgba(79, 70, 229, 0.9);
      border: none;
      border-radius: 3px;
      width: 20px;
      height: 20px;
      font-size: 10px;
      cursor: pointer;
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: background 0.2s ease;
    }
    .chairwoman-edit-btn:hover {
      background: rgba(79, 70, 229, 1);
    }

    .avatar{
      width:64px;
      height:64px;
      border-radius:50%;
      object-fit:cover;
      border:2px solid #fff;
      box-shadow:0 6px 16px rgba(0,0,0,.12)
    }

    .kbd{
      font-family:ui-monospace,SFMono-Regular,Menlo,Consolas,monospace;
      background:#111827;
      color:#fff;
      padding:3px 6px;
      border-radius:6px;
      font-size:12px;
      line-height:1.2;
      font-weight:500;
    }

    dialog{
      border:none;
      border-radius:16px;
      box-shadow:0 12px 30px rgba(0,0,0,.25);
      padding:16px;
    }

    /* ID CARD THEMES */
    .fade-ready{transition:opacity .2s ease;}
    .fade-out{opacity:0;}
    .fade-in{opacity:1;transition:opacity .4s ease;}

    .themeAFront,
    .themeBFront,
    .themeCFront,
    .themeDFront,
    .themeEFront,
    .themeFront,
    .themeGFront,
    .themeHFront{
      width:340px;
      height:540px;
    }
    .themeABack,
    .themeBBack,
    .themeCBack,
    .themeDBack,
    .themeEBack,
    .themeFBack,
    .themeGBack,
    .themeHBack{
      width:340px;
      height:540px;
    }

    /* THEME A */
    .themeAFront{
      background: radial-gradient(circle at top left,#fffceb 0%,#ffef6b 60%,#ffd000 100%);
      border:2px solid #000;
      border-radius:14px;
      position:relative;
      overflow:hidden;
      padding:10px 14px;
      font-family:Arial, sans-serif;
      color:#000;
    }
    .themeABack{
      background: radial-gradient(circle at top left,#fffceb 0%,#ffef6b 60%,#ffd000 100%);
      border:2px solid #000;
      border-radius:14px;
      position:relative;
      overflow:hidden;
      padding:14px;
      font-family:Arial, sans-serif;
      color:#000;
      font-size:12px;
      line-height:1.5;
    }

    /* THEME B */
    .themeBFront{
      background:linear-gradient(#ffffff 0%,#e8edf9 100%);
      border:2px solid #1e3a8a;
      border-radius:12px;
      position:relative;
      overflow:hidden;
      padding:12px 16px 16px;
      font-family:Arial, sans-serif;
      color:#000;
    }
    .themeBBack{
      background:linear-gradient(#ffffff 0%,#e8edf9 100%);
      border:2px solid #1e3a8a;
      border-radius:12px;
      position:relative;
      overflow:hidden;
      padding:16px;
      font-family:Arial, sans-serif;
      color:#000;
      font-size:12px;
      line-height:1.5;
    }
    .themeBFront .front-headerband{
      background:#1e3a8a;
      color:#fff;
      border-radius:8px;
      padding:8px;
      font-weight:700;
      text-align:center;
      margin-top:0;
    }
    .themeBFront .front-headerband .bgy-addr{color:#fff;}

    /* THEME D - Green / Nature */
    .themeDFront{
      background:linear-gradient(#ffffff 0%,#f0f9f0 100%);
      border:2px solid #16a34a;
      border-radius:12px;
      position:relative;
      overflow:hidden;
      padding:12px 16px 16px;
      font-family:Arial, sans-serif;
      color:#000;
    }
    .themeDBack{
      background:linear-gradient(#ffffff 0%,#f0f9f0 100%);
      border:2px solid #16a34a;
      border-radius:12px;
      position:relative;
      overflow:hidden;
      padding:16px;
      font-family:Arial, sans-serif;
      color:#000;
      font-size:12px;
      line-height:1.5;
    }
    .themeDFront .front-headerband{
      background:#16a34a;
      color:#fff;
      border-radius:8px;
      padding:8px;
      font-weight:700;
      text-align:center;
      margin-top:0;
    }
    .themeDFront .front-headerband .bgy-addr{color:#fff;}

    /* THEME E - Red / Heritage */
    .themeEFront{
      background:linear-gradient(#ffffff 0%,#fef2f2 100%);
      border:2px solid #dc2626;
      border-radius:12px;
      position:relative;
      overflow:hidden;
      padding:12px 16px 16px;
      font-family:Arial, sans-serif;
      color:#000;
    }
    .themeEBack{
      background:linear-gradient(#ffffff 0%,#fef2f2 100%);
      border:2px solid #dc2626;
      border-radius:12px;
      position:relative;
      overflow:hidden;
      padding:16px;
      font-family:Arial, sans-serif;
      color:#000;
      font-size:12px;
      line-height:1.5;
    }
    .themeEFront .front-headerband{
      background:#dc2626;
      color:#fff;
      border-radius:8px;
      padding:8px;
      font-weight:700;
      text-align:center;
      margin-top:0;
    }
    .themeEFront .front-headerband .bgy-addr{color:#fff;}

    /* THEME F - Purple / Modern */
    .themeFront{
      background:linear-gradient(#ffffff 0%,#faf5ff 100%);
      border:2px solid #9333ea;
      border-radius:12px;
      position:relative;
      overflow:hidden;
      padding:12px 16px 16px;
      font-family:Arial, sans-serif;
      color:#000;
    }
    .themeFBack{
      background:linear-gradient(#ffffff 0%,#faf5ff 100%);
      border:2px solid #9333ea;
      border-radius:12px;
      position:relative;
      overflow:hidden;
      padding:16px;
      font-family:Arial, sans-serif;
      color:#000;
      font-size:12px;
      line-height:1.5;
    }
    .themeFront .front-headerband{
      background:#9333ea;
      color:#fff;
      border-radius:8px;
      padding:8px;
      font-weight:700;
      text-align:center;
      margin-top:0;
    }
    .themeFront .front-headerband .bgy-addr{color:#fff;}

    /* THEME G - Orange / Sunset */
    .themeGFront{
      background:linear-gradient(#ffffff 0%,#fff7ed 100%);
      border:2px solid #ea580c;
      border-radius:12px;
      position:relative;
      overflow:hidden;
      padding:12px 16px 16px;
      font-family:Arial, sans-serif;
      color:#000;
    }
    .themeGBack{
      background:linear-gradient(#ffffff 0%,#fff7ed 100%);
      border:2px solid #ea580c;
      border-radius:12px;
      position:relative;
      overflow:hidden;
      padding:16px;
      font-family:Arial, sans-serif;
      color:#000;
      font-size:12px;
      line-height:1.5;
    }
    .themeGFront .front-headerband{
      background:#ea580c;
      color:#fff;
      border-radius:8px;
      padding:8px;
      font-weight:700;
      text-align:center;
      margin-top:0;
    }
    .themeGFront .front-headerband .bgy-addr{color:#fff;}

    /* THEME H - Teal / Ocean */
    .themeHFront{
      background:linear-gradient(#ffffff 0%,#f0fdfa 100%);
      border:2px solid #0d9488;
      border-radius:12px;
      position:relative;
      overflow:hidden;
      padding:12px 16px 16px;
      font-family:Arial, sans-serif;
      color:#000;
    }
    .themeHBack{
      background:linear-gradient(#ffffff 0%,#f0fdfa 100%);
      border:2px solid #0d9488;
      border-radius:12px;
      position:relative;
      overflow:hidden;
      padding:16px;
      font-family:Arial, sans-serif;
      color:#000;
      font-size:12px;
      line-height:1.5;
    }
    .themeHFront .front-headerband{
      background:#0d9488;
      color:#fff;
      border-radius:8px;
      padding:8px;
      font-weight:700;
      text-align:center;
      margin-top:0;
    }
    .themeHFront .front-headerband .bgy-addr{color:#fff;}

    /* THEME C */
    .themeCFront{
      background:linear-gradient(160deg,#0c0c0c 0%,#1a1a1a 60%,#222 100%);
      border:2px solid #d4af37;
      border-radius:12px;
      position:relative;
      overflow:hidden;
      padding:12px 16px 16px;
      font-family:"Segoe UI",Arial,sans-serif;
      color:#fefefe;
      box-shadow:0 0 8px rgba(212,175,55,0.6);
    }
    .themeCFront .front-headerband{
      background:linear-gradient(90deg,#d4af37 0%,#b8860b 100%);
      color:#111;
      border-radius:8px;
      padding:8px;
      font-weight:700;
      text-align:center;
      margin-top:0;
    }
    .themeCFront .bgy-name{color:#d4af37;font-weight:800;}
    .themeCFront .bgy-addr{
      color:#f0e68c;
      font-style:italic;
      font-weight:600;
    }
    .themeCFront .front-photo{
      background:#000;
      border:2px solid #d4af37;
      border-radius:8px;
      width:140px;
      height:180px;
      margin:16px auto 6px;
      overflow:hidden;
    }
    .themeCFront .front-photo img{
      width:100%;
      height:100%;
      object-fit:cover;
    }
    .themeCFront .person-name{
      color:#d4af37;
      font-size:20px;
      font-weight:700;
      text-transform:uppercase;
    }
    .themeCFront .person-role{
      color:#dc2626;
      font-size:18px;
      font-weight:800;
      letter-spacing:.5px;
      text-transform:uppercase;
    }
    .themeCFront .front-signature-img{
      border:1px solid #d4af37;
    }
    .themeCFront .front-signature-label{
      color:#fefefe;
    }
    .themeCFront .front-idnumber{
      color:#d4af37;
      font-weight:700;
    }

    .themeCBack{
      background:linear-gradient(160deg,#0d0d0d 0%,#1a1a1a 60%,#222 100%);
      border:2px solid #d4af37;
      border-radius:12px;
      position:relative;
      overflow:hidden;
      padding:16px;
      font-family:"Segoe UI",Arial,sans-serif;
      color:#f0e68c;
      line-height:1.5;
    }
    .themeCBack *{
      color:inherit;
    }
    .themeCBack .back-confirmation-title{
      color:#d4af37;
      text-decoration:underline;
      font-weight:700;
    }
    .themeCBack .captain-name{
      color:#d4af37;
      font-weight:700;
      text-align:center;
    }
    .themeCBack .back-contact-block{
      color:#f0e68c;
    }
    .themeCBack .back-confirmation-title{
      color:#d4af37;
    }
    .themeCBack .back-body-text{
      color:#f0e68c;
    }
    .themeCBack .back-expiry{
      color:#d4af37;
    }
    .themeCBack .back-sig-captain{
      color:#f0e68c;
    }
    .themeCBack .captain-name{
      color:#d4af37;
    }

    /* shared card blocks */
    .front-logos{
      display:flex;
      justify-content:center;
      align-items:flex-start;
      gap:8px;
      margin-bottom:4px;
    }
    .front-logo{
      height:50px;
      width:auto;
      object-fit:contain;
    }
    .front-headerband{
      background:#000;
      color:#fff;
      text-align:center;
      border-radius:6px;
      padding:6px 4px;
      font-size:13px;
      line-height:1.3;
      margin-top:6px;
    }
    .front-headerband .bgy-name{
      font-weight:800;
      font-size:13px;
      color:#fff;
    }
    .front-headerband .bgy-addr{
      font-style:italic;
      font-size:11px;
      font-weight:normal;
      color:#fff;
    }
    .front-photo{
      margin:16px auto 6px;
      width:140px;
      height:180px;
      background:#fff;
      border:2px solid #000;
      border-radius:8px;
      overflow:hidden;
    }
    .front-photo img{
      width:100%;
      height:100%;
      object-fit:cover;
    }
    .front-nameblock{text-align:center;margin-top:10px;}
    .person-name{
      font-weight:800;
      font-size:18px;
      text-transform:uppercase;
      color:#000;
    }
    .person-role{
      font-weight:800;
      font-size:18px;
      color:#dc2626;
      text-transform:uppercase;
    }
    .front-signature-wrapper{
      margin-top:20px;
      text-align:center;
    }
    .front-signature-img{
      width:140px;
      height:40px;
      object-fit:contain;
      border:1px solid #000;
      display:block;
      margin:0 auto;
      background:#fff;
    }
    .front-signature-label{
      font-size:12px;
      margin-top:2px;
      font-weight:700;
      color:#000;
      text-align:center;
    }
    .front-idnumber{
      margin-top:18px;
      text-align:center;
      font-weight:700;
      font-size:12px;
      color:#000;
    }
    /* .front-barcode - REMOVED as per client request */

    .back-contact-block{
      font-weight:700;
      margin-bottom:10px;
      font-size:12px;
      color:#000;
    }
    .back-confirmation-title{
      text-align:center;
      font-weight:800;
      text-decoration:underline;
      margin-bottom:10px;
      font-size:14px;
      color:#000;
    }
    .back-body-text{
      font-size:12px;
      text-align:justify;
      margin-bottom:16px;
      color:#000;
    }
    .back-expiry{
      font-size:12px;
      font-weight:700;
      margin-bottom:20px;
      text-align:center;
      color:#000;
    }
    .back-sig-captain{
      text-align:center;
      font-size:12px;
      font-weight:700;
      color:#000;
    }
    .captain-signature-line{
      width:180px;
      height:40px;
      margin:0 auto 4px;
      border-top:1px solid #000;
      position:relative;
    }
    .captain-signature-img{
      max-height:40px;
      max-width:160px;
      object-fit:contain;
      position:absolute;
      left:50%;
      top:0;
      transform:translateX(-50%);
    }
    .captain-name{
      font-size:12px;
      font-weight:700;
      text-align:center;
      color:#000;
    }

    /* PVC print wrappers */
    .print-area{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      vertical-align:middle; /* keeps alignment with surrounding inline elements */
    }
    .print-area-pvc.hidden{display:none;}
    /* Center the front/back card wrappers inside the ID generator preview only */
    #page-idgen .card.span-9 .row > div {
      display: flex;
      align-items: center;
      justify-content: center;
    }
    @media print {
      body *{visibility:hidden !important;}
      .print-area-pvc{
        position:fixed;
        inset:0;
        margin:auto;
        min-width:0;
        min-height:0;
        display:flex;
        align-items:center;
        justify-content:center;
      }
      .print-area-pvc.printing-now,
      .print-area-pvc.printing-now *{
        visibility:visible !important;
      }
      .print-area-pvc .themeAFront,
      .print-area-pvc .themeABack,
      .print-area-pvc .themeBFront,
      .print-area-pvc .themeBBack,
      .print-area-pvc .themeCFront,
      .print-area-pvc .themeCBack,
      .print-area-pvc .themeDFront,
      .print-area-pvc .themeDBack,
      .print-area-pvc .themeEFront,
      .print-area-pvc .themeEBack,
      .print-area-pvc .themeFront,
      .print-area-pvc .themeFBack,
      .print-area-pvc .themeGFront,
      .print-area-pvc .themeGBack,
      .print-area-pvc .themeHFront,
      .print-area-pvc .themeHBack{
        width:85.6mm !important;
        height:54mm !important;
        border-radius:4mm !important;
        padding:4mm !important;
        box-sizing:border-box !important;
        font-size:3.2mm !important;
        line-height:1.35 !important;
        color:#000;
        display:flex;
        flex-direction:column;
      }
      .print-area-pvc .front-barcode{
        width:30mm !important;
        height:10mm !important;
        border:0.3mm solid #000 !important;
        border-radius:1mm !important;
        margin:2mm auto 0 !important;
        background:#fff !important;
        display:flex !important;
        align-items:center !important;
        justify-content:center !important;
      }
      .print-area-pvc .front-barcode svg{
        max-width:28mm !important;
        max-height:9mm !important;
      }
      .print-area-pvc .back-contact-block,
      .print-area-pvc .back-body-text,
      .print-area-pvc .back-expiry,
      .print-area-pvc .back-sig-captain,
      .print-area-pvc .captain-name,
      .print-area-pvc .back-confirmation-title{
        font-size:3mm !important;
        line-height:1.35 !important;
      }
    }

    footer.app-footer{
      margin-top:32px;
      padding:24px 16px 40px;
      text-align:center;
      font-size:12px;
      color:var(--muted);
    }
    footer .footer-top{
      font-weight:600;
      color:var(--ink);
      font-size:12px;
    }
    footer .footer-bottom{
      margin-top:4px;
      line-height:1.4;
    }
  </style>
</head>
<body>

  <!-- ======= HEADER / GOV MASTHEAD ======= -->
  <header role="banner" aria-label="System header and navigation" class="system-header">
    <div class="container">
      <!-- Top row: Logo, Title, Auth -->
      <div class="header-top-row">
        <!-- Hamburger button (visible on mobile only) -->
        <button class="hamburger-btn" id="navToggle" aria-label="Toggle navigation menu" aria-expanded="false">
          <span class="hamburger-line"></span>
          <span class="hamburger-line"></span>
          <span class="hamburger-line"></span>
        </button>

        <!-- Brand Section -->
        <div class="masthead-brand">
          <div class="brand-logo">
            <img src="https://img.icons8.com/color/48/stack-of-paper.png" width="48" height="48" alt="Barangay Seal" class="seal-image"/>
          </div>
          
          <div class="brand-content">
            <div class="brand-title">
              <h1 class="system-name">Digital ID E-Services System</h1>
              <span class="status-badge" id="roleBadge">Signed-out</span>
            </div>
            <p class="brand-subtitle">
              <span class="portal-type">Admin Portal</span>
              <span class="separator">â€¢</span>
              <span class="gov-entity">Republic of the Philippines</span>
              <span class="separator">â€¢</span>
              <span class="usage-notice">Barangay / LGU Use Only</span>
            </p>
          </div>
        </div>

        <!-- Authentication Section -->
        <div class="header-auth">
          <div class="auth-user-info" id="authUserInfo" style="display:none;">
            <div class="user-avatar">
              <svg width="32" height="32" viewBox="0 0 32 32" fill="none" xmlns="http://www.w3.org/2000/svg">
                <circle cx="16" cy="16" r="16" fill="#2563eb" opacity="0.1"/>
                <circle cx="16" cy="13" r="5" fill="#2563eb"/>
                <path d="M8 26c0-4.418 3.582-8 8-8s8 3.582 8 8" fill="#2563eb"/>
              </svg>
            </div>
            <div class="user-details">
              <span class="user-name" id="currentUserName">Admin User</span>
              <span class="user-role" id="currentUserRole">Administrator</span>
            </div>
          </div>
          
          <button class="btn-auth btn-login" id="btnLogin" aria-label="Login to system">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M15 3h4a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2h-4"></path>
              <polyline points="10 17 15 12 10 7"></polyline>
              <line x1="15" y1="12" x2="3" y2="12"></line>
            </svg>
            <span>Login</span>
          </button>
          
          <button class="btn-auth btn-logout hidden" id="btnLogout" aria-label="Logout from system">
            <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path>
              <polyline points="16 17 21 12 16 7"></polyline>
              <line x1="21" y1="12" x2="9" y2="12"></line>
            </svg>
            <span>Logout</span>
          </button>
        </div>
      </div>

      <!-- Navigation Bar -->
      <div class="nav-wrapper">
        <nav id="topnav" role="navigation" aria-label="Main navigation">
          <button data-page="dashboard" class="nav-btn active" aria-current="page">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <rect x="3" y="3" width="7" height="7"></rect>
              <rect x="14" y="3" width="7" height="7"></rect>
              <rect x="14" y="14" width="7" height="7"></rect>
              <rect x="3" y="14" width="7" height="7"></rect>
            </svg>
            <span>Dashboard</span>
          </button>
          <button data-page="residents" class="nav-btn">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
              <circle cx="9" cy="7" r="4"></circle>
              <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
              <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
            </svg>
            <span>Residents</span>
          </button>
          <button data-page="idgen" class="nav-btn">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <rect x="2" y="4" width="20" height="16" rx="2"></rect>
              <path d="M7 15h0M2 9.5h20"></path>
            </svg>
            <span>ID Generator</span>
          </button>
          <button data-page="edocs" class="nav-btn">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
              <polyline points="14 2 14 8 20 8"></polyline>
              <line x1="16" y1="13" x2="8" y2="13"></line>
              <line x1="16" y1="17" x2="8" y2="17"></line>
              <polyline points="10 9 9 9 8 9"></polyline>
            </svg>
            <span>E-Docs</span>
          </button>
          <button data-page="complaints" class="nav-btn">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
            </svg>
            <span>Complaints</span>
          </button>
          <button data-page="reports" class="nav-btn">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <line x1="18" y1="20" x2="18" y2="10"></line>
              <line x1="12" y1="20" x2="12" y2="4"></line>
              <line x1="6" y1="20" x2="6" y2="14"></line>
            </svg>
            <span>Reports</span>
          </button>
          <button data-page="settings" class="nav-btn">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <circle cx="12" cy="12" r="3"></circle>
              <path d="M12 1v6m0 6v6m0-12l-5.2 3m10.4 0L12 7m5.2 6L12 16m-5.2-3L12 16"></path>
            </svg>
            <span>Settings</span>
          </button>
        </nav>
      </div>
    </div>
  </header>

  <!-- ======= MAIN ======= -->
  <main class="container" role="main">

    <!-- DASHBOARD -->
    <section id="page-dashboard" aria-labelledby="dash-header">
      <div class="grid">

        <!-- KPIs -->
        <!-- Dashboard Stats Cards Grid -->
        <div class="card span-12" style="padding:24px;">
          <div class="section-header" style="margin-bottom:20px;">
            <div class="section-title-block">
              <div class="section-eyebrow">Main Services</div>
              <div class="section-title" id="dash-header">Dashboard Overview</div>
              <div class="section-desc">
                Quick access to key barangay services and statistics
              </div>
            </div>
          </div>

          <!-- Stats Cards Grid -->
          <div class="dashboard-stats-grid">
            <!-- Mag-register ng Residente Card -->
            <div class="dashboard-stat-card" style="background:linear-gradient(135deg, #EBF4FF 0%, #C3DAFE 100%);border-left:4px solid #3B82F6;">
              <div class="stat-card-icon" style="background:linear-gradient(135deg, #DBEAFE 0%, #BFDBFE 100%);">
                <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="#3B82F6" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                  <path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                  <circle cx="8.5" cy="7" r="4"></circle>
                  <polyline points="17 11 19 13 23 9"></polyline>
                </svg>
              </div>
              <div class="stat-card-content">
                <h3 class="stat-card-title">Mag-register ng Residente</h3>
                <p class="stat-card-desc">Bagong residente registration</p>
                <div class="stat-card-value" id="statResidents">
                  <span class="stat-number">0</span>
                  <span class="stat-label">Total Residents</span>
                </div>
              </div>
              <div class="stat-card-indicator" style="background:#3B82F6;"></div>
            </div>

            <!-- Mga Residente Card -->
            <div class="dashboard-stat-card" style="background:linear-gradient(135deg, #D1FAE5 0%, #A7F3D0 100%);border-left:4px solid #10B981;">
              <div class="stat-card-icon" style="background:linear-gradient(135deg, #D1FAE5 0%, #A7F3D0 100%);">
                <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="#10B981" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                  <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
                  <circle cx="9" cy="7" r="4"></circle>
                  <path d="M23 21v-2a4 4 0 0 0-3-3.87"></path>
                  <path d="M16 3.13a4 4 0 0 1 0 7.75"></path>
                </svg>
              </div>
              <div class="stat-card-content">
                <h3 class="stat-card-title">Mga Residente</h3>
                <p class="stat-card-desc">Tingnan ang lahat ng residents</p>
                <div class="stat-card-value">
                  <span class="stat-number" id="statResidentsCount">0</span>
                  <span class="stat-label">Active Records</span>
                </div>
              </div>
              <div class="stat-card-indicator" style="background:#10B981;"></div>
            </div>

            <!-- ID Status Card -->
            <div class="dashboard-stat-card" style="background:linear-gradient(135deg, #FEF3C7 0%, #FDE68A 100%);border-left:4px solid #F59E0B;">
              <div class="stat-card-icon" style="background:linear-gradient(135deg, #FEF3C7 0%, #FDE68A 100%);">
                <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="#F59E0B" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                  <rect x="2" y="4" width="20" height="16" rx="2"></rect>
                  <path d="M7 15h0M2 9.5h20"></path>
                </svg>
              </div>
              <div class="stat-card-content">
                <h3 class="stat-card-title">ID Status</h3>
                <p class="stat-card-desc">Tingnan ang status ng mga ID</p>
                <div class="stat-card-value" id="statPending">
                  <span class="stat-number">0</span>
                  <span class="stat-label">IDs Pending</span>
                </div>
              </div>
              <div class="stat-card-indicator" style="background:#F59E0B;"></div>
            </div>

            <!-- Mga Dokumento Card -->
            <div class="dashboard-stat-card" style="background:linear-gradient(135deg, #E0E7FF 0%, #C7D2FE 100%);border-left:4px solid #8B5CF6;">
              <div class="stat-card-icon" style="background:linear-gradient(135deg, #EDE9FE 0%, #DDD6FE 100%);">
                <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="#8B5CF6" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                  <path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path>
                  <polyline points="14 2 14 8 20 8"></polyline>
                  <line x1="16" y1="13" x2="8" y2="13"></line>
                  <line x1="16" y1="17" x2="8" y2="17"></line>
                  <polyline points="10 9 9 9 8 9"></polyline>
                </svg>
              </div>
              <div class="stat-card-content">
                <h3 class="stat-card-title">Mga Dokumento</h3>
                <p class="stat-card-desc">E-document requests</p>
                <div class="stat-card-value" id="statReleased">
                  <span class="stat-number">0</span>
                  <span class="stat-label">IDs Released</span>
                </div>
              </div>
              <div class="stat-card-indicator" style="background:#8B5CF6;"></div>
            </div>

            <!-- Complaints & Feedback Card -->
            <div class="dashboard-stat-card" style="background:linear-gradient(135deg, #FECDD3 0%, #FCA5A5 100%);border-left:4px solid #EF4444;">
              <div class="stat-card-icon" style="background:linear-gradient(135deg, #FEE2E2 0%, #FECACA 100%);">
                <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="#EF4444" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                  <path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path>
                </svg>
              </div>
              <div class="stat-card-content">
                <h3 class="stat-card-title">Complaints & Feedback</h3>
                <p class="stat-card-desc">Mga reklamo at suggestions</p>
                <div class="stat-card-value">
                  <span class="stat-number">0</span>
                  <span class="stat-label">Active Cases</span>
                </div>
              </div>
              <div class="stat-card-indicator" style="background:#EF4444;"></div>
            </div>

            <!-- Events & Programs Card -->
            <div class="dashboard-stat-card" style="background:linear-gradient(135deg, #CCFBF1 0%, #99F6E4 100%);border-left:4px solid #14B8A6;">
              <div class="stat-card-icon" style="background:linear-gradient(135deg, #CCFBF1 0%, #99F6E4 100%);">
                <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="#14B8A6" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                  <rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect>
                  <line x1="16" y1="2" x2="16" y2="6"></line>
                  <line x1="8" y1="2" x2="8" y2="6"></line>
                  <line x1="3" y1="10" x2="21" y2="10"></line>
                </svg>
              </div>
              <div class="stat-card-content">
                <h3 class="stat-card-title">Events & Programs</h3>
                <p class="stat-card-desc">Barangay events at programs</p>
                <div class="stat-card-value">
                  <span class="stat-number">0</span>
                  <span class="stat-label">Upcoming Events</span>
                </div>
              </div>
              <div class="stat-card-indicator" style="background:#14B8A6;"></div>
            </div>
          </div>

          <!-- System Status Banner -->
          <div class="system-status-banner">
            <div class="status-icon">
              <svg width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#10B981" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"></path>
                <path d="M9 12l2 2 4-4"></path>
              </svg>
            </div>
            <div class="status-content">
              <h4 class="status-title">System Status: Online</h4>
              <p class="status-message">Lahat ng sistema ay gumagana. May mga tanong? Makipag-ugnayan sa barangay office.</p>
            </div>
          </div>
        </div>

        <!-- Audit log preview -->
        <aside class="card span-12" aria-labelledby="audit-header">
          <div class="section-header">
            <div class="section-title-block">
              <div class="section-eyebrow">Recent Activity</div>
              <div class="section-title" id="audit-header">Audit log (latest)</div>
            </div>
          </div>

          <div id="auditLatest"
               class="muted"
               style="max-height:80px;overflow:auto;font-size:13px;line-height:1.4;">
          </div>
        </aside>
      </div>

      <!-- Backup & Restore -->
      <div class="grid" style="margin-top:16px;">
        <section class="card span-12" id="page-backup" aria-labelledby="backup-header">
          <div class="section-header">
            <div class="section-title-block">
              <div class="section-eyebrow">Data Integrity</div>
              <div class="section-title" id="backup-header">Database Backup &amp; Restore</div>
              <div class="section-desc">
                Exports all barangay records (Residents, Requests, Complaints, Audit Log, Events/Attendance if any)
                to a local file. This works offline. You may keep that file in USB / external drive, or restore if data was lost.
              </div>
            </div>
          </div>

          <div class="row mb16" style="flex-wrap:wrap;gap:8px">
            <button class="btn" id="btnExportCSV" aria-label="Export all data in CSV format">ðŸ“¤ Export All (CSV)</button>
            <button class="btn" id="btnExportJSON" aria-label="Export all data in JSON format">ðŸ“¦ Export All (JSON)</button>
            <button class="btn secondary" id="btnImportBackup" aria-label="Import a backup JSON file">ðŸ“¥ Import Backup (JSON)</button>
          </div>

          <input
            type="file"
            id="importFileInput"
            accept="application/json"
            class="hidden"
            aria-hidden="true"
          />

          <div class="muted" style="font-size:13px;line-height:1.4">
            <div><b>Auto-backup schedule:</b> Every Friday 5:00 PM (device local time)</div>
            <div>Status: <span id="autoBackupStatus">Idle</span></div>
          </div>

          <p class="muted" style="font-size:12px;margin-top:12px;line-height:1.4;">
            Restoring a backup will <b>OVERWRITE</b> current data on this device. Only do this on a new / empty device,
            or if records were lost. Maintain offline copies following barangay data retention policy.
          </p>
        </section>
      </div>
    </section>


    <!-- RESIDENTS -->
    <section id="page-residents" class="hidden" aria-labelledby="resident-header">
      <div class="grid">

        <!-- Add / Register resident -->
        <div class="card span-4">
          <div class="section-header">
            <div class="section-title-block">
              <div class="section-eyebrow">Enrollment</div>
              <div class="section-title" id="resident-header">Register Resident</div>
              <div class="section-desc">
                Capture resident details, photo, signature and supporting documents.
              </div>
            </div>
          </div>

          <form id="resForm">
            <label>Full Name</label>
            <input required id="fullName" placeholder="e.g., Juan Dela Cruz" />

            <label>Birthdate</label>
            <input type="date" required id="birthdate" />

            <label>Address</label>
            <input required id="address" placeholder="House #, Street, Purok" />

            <label>Contact #</label>
            <input required id="contact" placeholder="09xx..." />

            <label>Purok / Position (e.g. Purok Leader)</label>
            <input id="purok" placeholder="PUROK LEADER / Purok 1" />

            <label>Tanod emergency contact</label>
            <input id="tanod" placeholder="Name / Hotline" />

            <label>Household ID / Head</label>
            <input id="household" placeholder="HH-0001 or Name" />

            <label>ID Photo (auto-crop)</label>
            <input type="file" id="photo" accept="image/*" />
            <div class="row center mb8"><img id="preview" class="avatar hidden" alt="ID photo preview"/></div>

            <label>Digital Signature (upload or scan later)</label>
            <input type="file" id="signature" accept="image/*" />
            <div class="row center mb8"><img id="sigPreview" class="hidden" style="max-height:60px" alt="Signature preview"/></div>

            <label>Supporting Documents (PDF/JPG/PNG)</label>
            <input type="file" id="docs" multiple accept="application/pdf,image/*" />

            <div class="row right">
              <button class="btn" type="submit">Save Resident</button>
            </div>
          </form>
        </div>

        <!-- Resident table / list -->
        <div class="card span-8">
          <div class="section-header">
            <div class="section-title-block">
              <div class="section-eyebrow">Records</div>
              <div class="section-title">Resident List</div>
              <div class="section-desc">
                View, edit, or open a record for ID printing. Track issuance status.
              </div>
            </div>

            <div class="row" style="gap:8px;flex-wrap:wrap;align-items:flex-start;">
              <input id="resSearch" class="pill" placeholder="Search name / ID #" />
              <button class="btn secondary" id="btnExportCSV" style="white-space:nowrap;">
                Export CSV
              </button>
            </div>
          </div>

          <div class="table-wrapper" style="overflow-x:auto;">
            <table aria-label="Resident table">
              <thead>
                <tr>
                  <th scope="col">ID #</th>
                  <th scope="col">Name</th>
                  <th scope="col">Purok</th>
                  <th scope="col">Status</th>
                  <th scope="col">Released Date</th>
                  <th scope="col"></th>
                </tr>
              </thead>
              <tbody id="resTable"></tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- Edit modal -->
      <dialog id="editModal" aria-modal="true" aria-labelledby="edit-resident-title">
        <form method="dialog" id="editForm" style="min-width:560px">
          <h2 id="edit-resident-title" style="margin-bottom:12px;">Edit Resident</h2>
          <div class="row" style="align-items:flex-start;">
            <div class="span-6" style="flex:1;min-width:240px;">
              <label>Full Name</label><input id="e_name" />
              <label>Birthdate</label><input type="date" id="e_birthdate" />
              <label>Address</label><input id="e_address" />
              <label>Contact</label><input id="e_contact" />
              <label>Purok / Position</label><input id="e_purok" />
              <label>Tanod</label><input id="e_tanod" />
              <label>Household</label><input id="e_household" />
            </div>
            <div class="span-6" style="flex:1;min-width:240px;">
              <label>Replace ID Photo</label><input type="file" id="e_photo" accept="image/*" />
              <label>Replace Signature</label><input type="file" id="e_signature" accept="image/*" />

              <div class="row" style="margin-top:16px;">
                <button class="btn" value="save">Save</button>
                <button class="btn secondary" value="cancel">Cancel</button>
              </div>
            </div>
          </div>
        </form>
      </dialog>
    </section>


    <!-- ID GENERATOR & VERIFICATION -->
    <section id="page-idgen" class="hidden" aria-labelledby="idgen-header">
      <div class="grid">

        <!-- Left panel -->
        <aside class="card span-3">
          <div class="section-header">
            <div class="section-title-block">
              <div class="section-eyebrow">ID Printing</div>
              <div class="section-title" id="idgen-header">Search Resident</div>
              <div class="section-desc">
                Load record, choose layout template, and print PVC front/back.
              </div>
            </div>
          </div>

          <input id="searchId" placeholder="Enter ID # or name" aria-label="Search resident by ID or name"/>
          <div id="searchResults"
              class="muted"
              style="margin-top:8px;font-size:13px;line-height:1.4"></div>

          <div class="mb16" style="margin-top:16px;"></div>

          <label style="font-size:14px;color:#6b7280">Card Design</label>
          <select id="templateSelect" class="pill" style="width:100%">
            <option value="A">Template A â€“ Yellow / Official</option>
            <option value="B">Template B â€“ Blue / Alternate</option>
            <option value="C">Template C â€“ Black &amp; Gold</option>
            <option value="D">Template D â€“ Green / Nature</option>
            <option value="E">Template E â€“ Red / Heritage</option>
            <option value="F">Template F â€“ Purple / Modern</option>
            <option value="G">Template G â€“ Orange / Sunset</option>
            <option value="H">Template H â€“ Teal / Ocean</option>
          </select>

          <div id="themePreviewText"
              class="muted"
              style="font-size:12px;margin-top:4px;line-height:1.4;">
            Currently: Theme A â€“ Yellow (Official)
          </div>

          <div class="mb16" style="margin-top:16px;"></div>

          <label style="font-size:14px;color:#6b7280">Edit Mode</label>
          <div class="row" style="align-items:center;gap:8px;margin-bottom:12px;padding:8px;border-radius:6px;background:#f9fafb;">
            <input type="checkbox" id="editModeToggle" style="width:auto;margin:0;">
            <label for="editModeToggle" style="margin:0;font-size:13px;color:#6b7280;cursor:pointer;">
              Allow editing information on ID preview
            </label>
            <span id="editModeStatus" style="font-size:11px;color:#9ca3af;margin-left:auto;">Disabled</span>
          </div>

          <button class="btn secondary" id="btnReprint" style="width:100%">
            Reprint Current
          </button>
        </aside>

        <!-- PVC Preview -->
        <section class="card span-9">
          <div class="section-header">
            <div class="section-title-block">
              <div class="section-eyebrow">PVC Preview</div>
              <div class="section-title">Fixed Template â€” Front &amp; Back</div>
              <div class="section-desc">
                Review name, position, signature block, barcode, and appointment text before printing.
              </div>
            </div>
          </div>

          <div class="row" style="gap:40px;align-items:flex-start;flex-wrap:wrap;justify-content:center">

            <!-- FRONT CARD -->
            <div>
              <div class="print-area">
                <div id="idFront" class="themeAFront fade-ready">

                  <!-- LOGOS -->
                  <div class="front-logos" aria-hidden="true">
                    <img src="assets/brgy-holy-spirit-logo.jpg"
                        class="front-logo"
                        alt="Barangay Holy Spirit Logo">
                    <img src="assets/Quezon_City_LGU_logo.jpg"
                        class="front-logo"
                        alt="Quezon City Logo">
                    <img src="assets/Bagong_Pilipinas_logo.png"
                        class="front-logo"
                        alt="Bagong Pilipinas Logo">
                  </div>

                  <!-- HEADER BAND -->
                  <div class="front-headerband">
                    <div class="bgy-name">BARANGAY HOLY SPIRIT</div>
                    <div class="bgy-addr">06 Faustino St, Quezon City, Philippines</div>
                  </div>

                  <!-- PHOTO -->
                  <div class="front-photo" aria-label="Resident photo">
                    <img id="idPhoto" alt="Resident Photo"/>
                    <div class="photo-edit-overlay" id="photoEditOverlay" style="display:none;">
                      <button type="button" class="photo-edit-btn" id="changePhotoBtn" title="Change Photo">ðŸ“·</button>
                      <button type="button" class="photo-edit-btn" id="deletePhotoBtn" title="Delete Photo">ðŸ—‘ï¸</button>
                    </div>
                    <input type="file" id="photoFileInput" accept="image/*" style="display:none;">
                  </div>

                  <!-- NAME + ROLE -->
                  <div class="front-nameblock">
                    <div class="person-name editable-field" id="frontFullName" contenteditable="false">FULL NAME HERE</div>
                    <div class="person-role editable-field" id="frontRole" contenteditable="false">PUROK LEADER</div>
                  </div>

                  <!-- SIGNATURE -->
                  <div class="front-signature-wrapper" aria-label="Resident signature block">
                    <img id="sigImg" class="front-signature-img" alt="Resident Signature"/>
                    <div class="signature-edit-overlay" id="signatureEditOverlay" style="display:none;">
                      <button type="button" class="signature-edit-btn" id="changeSignatureBtn" title="Change Signature">âœï¸</button>
                      <button type="button" class="signature-edit-btn" id="deleteSignatureBtn" title="Delete Signature">ðŸ—‘ï¸</button>
                    </div>
                    <input type="file" id="signatureFileInput" accept="image/*" style="display:none;">
                    <div class="front-signature-label">SIGNATURE</div>
                  </div>

                  <!-- ID NUMBER -->
                  <div class="front-idnumber">
                    ID NUMBER : <span class="editable-field" id="frontIdNumber" contenteditable="false">BHS0001</span>
                  </div>

                  <!-- STATUS BADGE -->
                  <div id="cardStatusBadge"
                      class="tag red"
                      style="margin-top:8px;text-align:center;justify-content:center;">
                    Pending
                  </div>
                </div><!-- /idFront -->
              </div><!-- /print-area -->
            </div>

            <!-- BACK CARD -->
            <div>
              <div id="idBack" class="themeABack fade-ready">

                <div class="back-contact-block">
                  Address:
                  <span class="editable-field" id="backAddress" contenteditable="false">#15 STA MARIA ST. BHSQC</span><br/>
                  Contact Number:
                  <span class="editable-field" id="backContact" contenteditable="false">0949-865-3987</span><br/>
                  Precinct Number:
                  <span class="editable-field" id="backPrecinct" contenteditable="false">1395-A</span>
                </div>

                <div class="back-confirmation-title">
                  CONFIRMATION OF APPOINTMENT
                </div>

                <div class="back-body-text">
                  BY VIRTUE OF POWER VESTED UNTO ME, I HEREBY CONFIRM YOUR
                  APPOINTMENT AS <span class="editable-field" id="backRole" contenteditable="false">PUROK LEADER</span> OF
                  BARANGAY HOLY SPIRIT. YOU SHALL SERVE IN SAID CAPACITY UNTIL
                  YOUR SUCCESSOR HAS BEEN DULY APPOINTED/QUALIFIED IN
                  ACCORDANCE WITH APPLICABLE LAWS AND/OR ANY EXISTING RULES
                  AND POLICIES GOVERNING BARANGAY. YOU SHALL COORDINATE WITH
                  BARANGAY OFFICIALS ON MATTERS CONCERNING IMPLEMENTATION /
                  VIOLATIONS OF ALL EXISTING LAWS, PROMOTE PEACE AND ORDER,
                  PROHIBIT ILLEGAL ACTIVITIES SUCH AS CONSTRUCTIONS, GAMBLING
                  AND PROTECT THE GENERAL WELFARE AND SECURITY OF LIVES,
                  RIGHTS AND PROPERTY OF OUR CONSTITUENTS WITHIN YOUR AREA
                  OF JURISDICTION. GIVEN THIS 1ST DAY OF AUGUST 2024
                </div>

                <div class="back-expiry">
                  ID EXPIRES : <span class="editable-field" id="backExpiry" contenteditable="false">DECEMBER 21, 2025</span>
                </div>

                <div class="back-sig-captain">
                  <div class="captain-signature-line">
                    <img src="assets/chairwoman-signature.png"
                        class="captain-signature-img" id="chairwomanImg"
                        alt="Barangay Chairwoman Signature"/>
                    <div class="chairwoman-edit-overlay" id="chairwomanEditOverlay" style="display:none;">
                      <button type="button" class="chairwoman-edit-btn" id="changeChairwomanBtn" title="Change Chairwoman Signature">âœï¸</button>
                      <button type="button" class="chairwoman-edit-btn" id="deleteChairwomanBtn" title="Delete Chairwoman Signature">ðŸ—‘ï¸</button>
                    </div>
                    <input type="file" id="chairwomanFileInput" accept="image/*" style="display:none;">
                  </div>
                  <div class="captain-name">
                    ESTRELLA C. VALMOCINA<br/>
                    BARANGAY CHAIRWOMAN
                  </div>
                </div>
              </div><!-- /idBack -->
            </div>
          </div><!-- /row -->

          <div class="row" style="margin-top:12px;flex-wrap:wrap;">
            <button class="btn ghost" id="btnPending">Mark Pending</button>
            <button class="btn" id="btnReleased">Mark Released</button>

            <button class="btn secondary" id="btnPrintPVCFront">Print Front (PVC)</button>
            <button class="btn secondary" id="btnPrintPVCBack">Print Back (PVC)</button>
          </div>

          <!-- Hidden PVC wrappers -->
          <div id="printFrontWrapper" class="print-area-pvc hidden">
            <div id="printFrontCard"></div>
          </div>
          <div id="printBackWrapper" class="print-area-pvc hidden">
            <div id="printBackCard"></div>
          </div>
        </section>

        <!-- Face verification -->
        <section class="card span-12" aria-labelledby="face-header">
          <div class="section-header">
            <div class="section-title-block">
              <div class="section-eyebrow">Identity Check</div>
              <div class="section-title" id="face-header">AI Face Verification</div>
              <div class="section-desc">
                Confirms live person = same face as stored ID photo. Helps prevent identity fraud.
              </div>
            </div>
          </div>

          <div class="row" style="align-items:flex-start;">
            <video id="cam"
                   autoplay playsinline
                   style="width:260px;border-radius:12px;background:#000"
                   aria-label="Live camera feed for verification"></video>

            <canvas id="overlay"
                    width="260"
                    height="195"
                    style="border-radius:12px"
                    aria-hidden="true"></canvas>

            <div style="flex:1;min-width:240px;">
              <p class="muted" style="font-size:13px;line-height:1.4;">
                System will (1) detect human face presence and (2) compare with resident's stored photo.
                Face models load on first use.
              </p>

              <div class="row">
                <button class="btn" id="btnStartCam">Start Camera</button>
                <button class="btn secondary" id="btnCapture">Capture &amp; Verify</button>
                <span id="veriStatus" class="tag amber">Idle</span>
              </div>

              <small class="muted" style="font-size:12px;line-height:1.4;">
                Threshold used: cosine distance â‰¤ <span class="kbd">0.5</span> (tuneable).
              </small>
            </div>
          </div>
        </section>
      </div><!-- /grid -->
    </section>

    <!-- PVC PRINT CONTAINERS (global fallback) -->
    <div id="printFrontWrapperGlobal" class="print-area-pvc hidden" aria-hidden="true">
      <div class="themeAFront" id="printFrontCardGlobal">
        <!-- clone of #idFront appears here -->
      </div>
    </div>

    <div id="printBackWrapperGlobal" class="print-area-pvc hidden" aria-hidden="true">
      <div class="themeABack" id="printBackCardGlobal">
        <!-- clone of #idBack appears here -->
      </div>
    </div>


    <!-- E-DOCS -->
    <section id="page-edocs" class="hidden" aria-labelledby="edocs-header">
      <div class="grid">

        <div class="card span-4">
          <div class="section-header">
            <div class="section-title-block">
              <div class="section-eyebrow">Request Intake</div>
              <div class="section-title" id="edocs-header">Resident Request</div>
              <div class="section-desc">
                Log requests for Barangay Clearance, Indigency Certificate, etc.
              </div>
            </div>
          </div>

          <form id="reqForm">
            <label>ID Number</label>
            <input id="reqId" required placeholder="e.g., BHSPK-2026-001" />

            <label>Document</label>
            <select id="reqDoc">
              <option>Barangay Clearance</option>
              <option>Certificate of Indigency</option>
              <option>Residency Certificate</option>
            </select>

            <label>Purpose (optional)</label>
            <textarea id="reqPurpose" placeholder="Job requirement, scholarship, etc."></textarea>

            <div class="row right"><button class="btn">Submit</button></div>
          </form>
        </div>

        <div class="card span-8">
          <div class="section-header">
            <div class="section-title-block">
              <div class="section-eyebrow">Tracking</div>
              <div class="section-title">Requests</div>
              <div class="section-desc">
                Status flow: Pending â†’ Approved â†’ Released.
              </div>
            </div>
          </div>

          <div class="table-wrapper" style="overflow-x:auto;">
            <table aria-label="E-document requests table">
              <thead>
                <tr>
                  <th scope="col">ID #</th>
                  <th scope="col">Doc</th>
                  <th scope="col">Purpose</th>
                  <th scope="col">Status</th>
                  <th scope="col"></th>
                </tr>
              </thead>
              <tbody id="reqTable"></tbody>
            </table>
          </div>
        </div>
      </div>

      <!-- OFFICIAL DOCUMENT PREVIEW / PRINT AREA -->
      <dialog id="docModal">
        <div style="max-width:800px;width:100%;padding:16px;">
          <div class="row" style="justify-content:space-between;align-items:flex-start;flex-wrap:wrap;">
            <h2 id="docTitleUI" style="margin:0;font-size:18px;font-weight:600;">Document Preview</h2>
            <div class="row" style="gap:8px;">
              <button class="btn secondary" id="btnCloseDocModal">Close</button>
              <button class="btn" id="btnPrintDoc" data-requires-role="staff">Print</button>
            </div>
          </div>

          <!-- This is what we actually print -->
          <div id="printDocWrapper" class="print-doc-wrapper">
            <!-- dynamic content injected here -->
          </div>
        </div>
      </dialog>
    </section>


    <!-- COMPLAINTS -->
    <section id="page-complaints" class="hidden" aria-labelledby="complaints-header">
      <div class="grid">

        <div class="card span-4">
          <div class="section-header">
            <div class="section-title-block">
              <div class="section-eyebrow">Feedback / Incident</div>
              <div class="section-title" id="complaints-header">Submit Complaint / Feedback</div>
              <div class="section-desc">
                Encode reports raised by constituents for tracking and follow-up.
              </div>
            </div>
          </div>

          <form id="cmpForm">
            <label>Resident ID #</label>
            <input id="cmpId" />

            <label>Details</label>
            <textarea id="cmpText" required></textarea>

            <div class="row right"><button class="btn">Submit</button></div>
          </form>
        </div>

        <div class="card span-8">
          <div class="section-header">
            <div class="section-title-block">
              <div class="section-eyebrow">Inbox</div>
              <div class="section-title">Logged Complaints / Messages</div>
              <div class="section-desc">
                Sorted by most recent. Includes timestamp of submission.
              </div>
            </div>
          </div>

          <div class="table-wrapper" style="overflow-x:auto;">
            <table aria-label="Complaints inbox table">
              <thead>
                <tr>
                  <th scope="col">ID #</th>
                  <th scope="col">Message</th>
                  <th scope="col">When</th>
                </tr>
              </thead>
              <tbody id="cmpTable"></tbody>
            </table>
          </div>
        </div>
      </div>
    </section>


    <!-- REPORTS -->
    <section id="page-reports" class="hidden" aria-labelledby="reports-header">
      <div class="card span-12">
        <div class="section-header">
          <div class="section-title-block">
            <div class="section-eyebrow">Summary</div>
            <div class="section-title" id="reports-header">Quick Reports</div>
            <div class="section-desc">
              Printable summaries for submission to higher offices / compliance.
            </div>
          </div>
        </div>

        <ul style="margin-top:8px;">
          <li>Total residents</li>
          <li>IDs pending vs released</li>
          <li>E-docs by status (Pending â†’ Approved â†’ Released)</li>
        </ul>
        <p class="muted" style="font-size:13px;line-height:1.4;">
          (Advanced printable PDF reports can be added.)
        </p>
      </div>
    </section>


    <!-- SETTINGS -->
    <section id="page-settings" class="hidden" aria-labelledby="settings-header">
      <div class="grid">

        <div class="card span-6">
          <div class="section-header">
            <div class="section-title-block">
              <div class="section-eyebrow">Accounts</div>
              <div class="section-title" id="settings-header">Roles &amp; Accounts (Demo)</div>
              <div class="section-desc">
                In production, credentials should be stored securely (hashed) and access should require admin approval / biometrics.
              </div>
            </div>
          </div>

          <div class="table-wrapper" style="overflow-x:auto;">
            <table aria-label="User roles table">
              <thead>
                <tr>
                  <th scope="col">User</th>
                  <th scope="col">Role</th>
                  <th scope="col">Login</th>
                </tr>
              </thead>
              <tbody>
                <tr><td>admin@example</td><td>Admin</td><td>admin123</td></tr>
                <tr><td>staff@example</td><td>Staff</td><td>staff123</td></tr>
              </tbody>
            </table>
          </div>
        </div>

        <div class="card span-6">
          <div class="section-header">
            <div class="section-title-block">
              <div class="section-eyebrow">AI Model</div>
              <div class="section-title">Face Models</div>
              <div class="section-desc">
                On first verification, face models are fetched. For offline (Capacitor app), these may be bundled locally.
              </div>
            </div>
          </div>

          <p class="muted" style="font-size:13px;line-height:1.4;">
            This module performs face detection and face match with adjustable threshold.
            For use by authorized barangay personnel only.
          </p>
        </div>
      </div>
    </section>

  </main>

  <!-- ======= FOOTER / COMPLIANCE ======= -->
  <footer class="app-footer" role="contentinfo">
    <div class="footer-top">Digital ID E-Services System (Core A)</div>
    <div class="footer-bottom">
      For Official Barangay / LGU Use Only â€¢ Offline-capable<br/>
      Â© 2025 Local Government Unit. All activities are logged.
    </div>
  </footer>

  <!-- ========= CORE APP LOGIC ========= -->
  <script>
    /************* DATA LAYER - SQLITE BACKEND (Clean Architecture) *************/
    /**
     * âœ… MIGRATION COMPLETE: IndexedDB â†’ SQLite Backend
     * 
     * Benefits:
     * - Data persists across browsers, devices, and incognito mode
     * - Centralized SQLite database for all data
     * - Proper transaction support and ACID compliance
     * - Better error handling and validation
     * - Automatic audit trail in database
     * - Multi-user concurrent access
     * - Easy backup/restore (database file)
     * 
     * All CRUD operations now use dataService.js:
     * - ResidentService: Full resident management
     * - RequestService: E-document requests
     * - ComplaintService: Feedback & complaints
     * - AuditService: System activity logs
     * - EventService: Events & attendance
     */

    // No initialization needed - dataService.js handles all backend communication

    /************* Auth (uses localStorage from index.html login) *************/
    let currentUser = null;

    // Initialize auth state from localStorage
    function initAuth() {
      const token = localStorage.getItem('token');
      const userRaw = localStorage.getItem('user');
      
      if (token && userRaw) {
        try {
          const user = JSON.parse(userRaw);
          currentUser = {
            user: user.email || user.username,
            role: user.role || 'staff'
          };
        } catch (e) {
          console.error('Failed to parse user data:', e);
        }
      }
    }

    // Call initAuth on page load
    initAuth();

    const btnLogin = document.getElementById('btnLogin');
    const btnLogout = document.getElementById('btnLogout');

    // Login button redirects to index.html
    if (btnLogin) {
      btnLogin.onclick = ()=>{
        window.location.href = 'index.html';
      };
    }

    // Logout button
    if (btnLogout) {
      btnLogout.onclick = async ()=>{
        await audit('logout',{user: currentUser?.user});
        
        // Clear localStorage
        localStorage.removeItem('token');
        localStorage.removeItem('user');
        
        // Redirect to login page
        window.location.href = 'index.html';
      };
    }

    function requireStaff(){
      const token = localStorage.getItem('token');
      const user = JSON.parse(localStorage.getItem('user') || '{}');
      
      if(!token || (!user.role || (user.role !== 'staff' && user.role !== 'admin'))) {
        alert('Login required. Redirecting to login page...');
        window.location.href = 'index.html';
        return false;
      }
      return true;
    }

    function requireAdmin(){
      const token = localStorage.getItem('token');
      const user = JSON.parse(localStorage.getItem('user') || '{}');
      
      if(!token || user.role !== 'admin') {
        alert('Admin access required');
        return false;
      }
      return true;
    }

    /************* Helpers *************/
    async function fileToDataURL(file){
      return new Promise((resolve)=>{
        const fr=new FileReader();
        fr.onload=()=>resolve(fr.result);
        fr.readAsDataURL(file);
      })
    }

    // auto-crop ID portrait 300x360
    async function cropToID(dataURL){
      return new Promise((resolve)=>{
        const img=new Image();
        img.onload=()=>{
          const W=300,H=360;
          const c=document.createElement('canvas');
          c.width=W; c.height=H;
          const ctx=c.getContext('2d');
          const s=Math.max(W/img.width,H/img.height);
          const w=img.width*s,h=img.height*s;
          const dx=(W-w)/2,dy=(H-h)/2;
          ctx.fillStyle='#fff'; ctx.fillRect(0,0,W,H);
          ctx.drawImage(img,dx,dy,w,h);
          resolve(c.toDataURL('image/jpeg',0.9));
        };
        img.src=dataURL;
      })
    }

    // generate new ID number (ex: BHSPK-2025-001)
    async function nextIdNumber(purok='BHSPK'){
      try {
        const result = await ResidentService.generateIdNumber(purok);
        return result.idNumber;
      } catch (error) {
        console.error('âŒ Failed to generate ID number:', error);
        // Fallback to local generation if backend fails
        const year = new Date().getFullYear();
        const prefix = `${(purok||'BHSPK').replaceAll(' ','').toUpperCase()}-${year}`;
        return `${prefix}-001`;
      }
    }

    function formatDate(ts){
      if(!ts) return '';
      const d=new Date(ts);
      return d.toLocaleString();
    }

    /************* Residents *************/
    const resForm = document.getElementById('resForm');
    const resTable = document.getElementById('resTable');
    const resSearch = document.getElementById('resSearch');
    const preview = document.getElementById('preview');
    const sigPreview = document.getElementById('sigPreview');
    const btnExportCSV = document.getElementById('btnExportCSV'); // NOTE: duplicated ID in DOM, we'll fix later in refactor

    const photoInput = document.getElementById('photo');
    photoInput?.addEventListener('change', async (e)=>{
      const f=e.target.files?.[0]; if(!f) return;
      const url=await fileToDataURL(f);
      const cropped=await cropToID(url);
      preview.src=cropped;
      preview.classList.remove('hidden');
      preview.dataset.cropped=cropped;
    });

    const signatureInput = document.getElementById('signature');
    signatureInput?.addEventListener('change', async (e)=>{
      const f=e.target.files?.[0]; if(!f) return;
      const url=await fileToDataURL(f);
      sigPreview.src=url;
      sigPreview.classList.remove('hidden');
      sigPreview.dataset.sig=url;
    });

    resForm?.addEventListener('submit', async (e)=>{
      e.preventDefault();
      if(!requireStaff()) return;

      try {
        const name = document.getElementById('fullName').value.trim();
        const birthdate = document.getElementById('birthdate').value;
        const address = document.getElementById('address').value.trim();
        const contact = document.getElementById('contact').value.trim();
        const purok = document.getElementById('purok').value.trim() || 'BHSPK';
        const tanod = document.getElementById('tanod').value.trim();
        const household = document.getElementById('household').value.trim();

        const photoData = preview.dataset.cropped || '';
        const sigData = sigPreview.dataset.sig || '';

        const idno = await nextIdNumber(purok);

        // Create resident via backend API
        const result = await ResidentService.create({
          fullName: name,
          birthDate: birthdate,
          address,
          contact,
          purokOrPosition: purok,
          emergencyContact: tanod,
          household,
          idNumber: idno,
          photoUrl: photoData,
          signatureUrl: sigData
        });

        console.log('âœ… Resident created:', result);
        
        // Reset form
        resForm.reset();
        preview.classList.add('hidden');
        sigPreview.classList.add('hidden');
        delete preview.dataset.cropped;
        delete sigPreview.dataset.sig;

        // Refresh UI
        await renderResidents();
        await updateDashboardStats();
        
        alert(`Resident ${name} registered successfully with ID: ${idno}`);
      } catch (error) {
        console.error('âŒ Failed to create resident:', error);
        alert(`Failed to register resident: ${error.message}`);
      }
    });

    async function renderResidents(filter=''){
      try {
        const list = await ResidentService.getAll(filter);
        list.sort((a,b)=>(a.idNumber||'').localeCompare(b.idNumber||''));

        if (!resTable) return;

        resTable.innerHTML = list.map(r=>{
          // Map backend schema to frontend display
          const tag = (r.status||'').toLowerCase() === 'released'
            ? '<span class="tag green">Released</span>'
            : '<span class="tag red">Pending</span>';

          return `<tr>
            <td>${r.idNumber||r.idno||''}</td>
            <td>${r.fullName||r.name||''}</td>
            <td>${r.purokOrPosition||r.purok||''}</td>
            <td>${tag}</td>
            <td>${formatDate(r.releasedAt)||''}</td>
            <td>
              <button class='btn ghost' data-action="open" data-id="${r.id}">Open</button>
              <button class='btn' data-action="edit" data-id="${r.id}">Edit</button>
              <button class='btn secondary' data-action="delete" data-id="${r.id}">Delete</button>
            </td>
          </tr>`;
        }).join('');

        resTable.querySelectorAll('button').forEach(btn=>{
          btn.addEventListener('click', async ()=>{
            const rid = btn.getAttribute('data-id');
            const act = btn.getAttribute('data-action');
            if(act==='open')  loadToID(rid);
            if(act==='edit')  openEdit(rid);
            if(act==='delete') removeResident(rid);
          });
        });

        await updateDashboardStats();
        console.log('âœ… Residents rendered:', list.length);
      } catch (error) {
        console.error('âŒ Failed to render residents:', error);
        if (resTable) resTable.innerHTML = `<tr><td colspan="6" style="text-align:center;color:red;">Failed to load residents. Please check backend connection.</td></tr>`;
      }
    }

    resSearch?.addEventListener('input', ()=>{
      renderResidents(resSearch.value);
    });

    // Export CSV
    btnExportCSV?.addEventListener('click', async ()=>{
      const list = await all('residents');
      const headers = [
        'ID Number',
        'Full Name',
        'Birthdate',
        'Address',
        'Contact',
        'Purok/Role',
        'Tanod Contact',
        'Household',
        'Status',
        'Released Date'
      ];

      const rows = list.map(r=>[
        r.idno || '',
        r.name || '',
        r.birthdate || '',
        (r.address||'').replace(/[\n\r]+/g,' '),
        r.contact || '',
        r.purok || '',
        r.tanod || '',
        r.household || '',
        r.status || '',
        r.releasedAt ? new Date(r.releasedAt).toLocaleString() : ''
      ]);

      function csvEscape(val){
        if(val==null) return '';
        const needsQuote = /[",\n]/.test(val);
        let v = String(val).replace(/"/g,'""');
        return needsQuote ? `"${v}"` : v;
      }

      const csvContent = [
        headers.map(csvEscape).join(','),
        ...rows.map(row=>row.map(csvEscape).join(','))
      ].join('\n');

      const blob = new Blob([csvContent], {type:'text/csv;charset=utf-8;'});
      const url = URL.createObjectURL(blob);

      const a = document.createElement('a');
      a.href = url;
      a.download = 'residents.csv';
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);

      URL.revokeObjectURL(url);

      await audit('export:residents_csv',{count: list.length});
    });

    async function removeResident(id){
      if(!requireStaff()) return;
      if(!confirm('Delete resident?')) return;
      try {
        const r = await ResidentService.getById(id);
        await ResidentService.delete(id);
        await audit('resident:delete',{idno:r?.idno,name:r?.name});
        renderResidents();
      } catch (error) {
        console.error('Error deleting resident:', error);
        alert('Failed to delete resident: ' + error.message);
      }
    }

    // edit modal
    const editModal=document.getElementById('editModal');
    const editForm=document.getElementById('editForm');
    let editId=null;

    async function openEdit(id){
      try {
        const r = await ResidentService.getById(id);
        if(!r) return;
        editId=id;
      e_name.value=r.name;
      e_birthdate.value=r.birthdate||'';
      e_address.value=r.address||'';
      e_contact.value=r.contact||'';
      e_purok.value=r.purok||'';
      e_tanod.value=r.tanod||'';
      e_household.value=r.household||'';
      editModal.showModal();
      } catch (error) {
        console.error('Error loading resident:', error);
        alert('Failed to load resident: ' + error.message);
      }
    }

    editForm.addEventListener('close',()=>{ editId=null; });
    editForm.addEventListener('submit', (e)=>{
      e.preventDefault();
    });

    editForm.addEventListener('click', async (e)=>{
      const val = e.target.value;
      if(!val) return;

      if(val==='save' && editId){
        if(!requireStaff()) return;
        try {
          const updateData = {
            name: e_name.value.trim(),
            birthdate: e_birthdate.value,
            address: e_address.value.trim(),
            contact: e_contact.value.trim(),
            purok: e_purok.value.trim(),
            tanod: e_tanod.value.trim(),
            household: e_household.value.trim()
          };

          if(e_photo.files?.[0]){
            const u=await fileToDataURL(e_photo.files[0]);
            updateData.photo=await cropToID(u);
          }
          if(e_signature.files?.[0]){
            updateData.signature=await fileToDataURL(e_signature.files[0]);
          }

          await ResidentService.update(editId, updateData);
          await audit('resident:edit',{idno: updateData.name});
          editModal.close();
          renderResidents();
        } catch (error) {
          console.error('Error updating resident:', error);
          alert('Failed to update resident: ' + error.message);
        }
      }

      if(val==='cancel'){
        editModal.close();
      }
    });

    /************* ID GENERATOR + THEME SWITCH *************/
    // FRONT FIELDS
    const frontFullName   = document.getElementById('frontFullName');
    const frontRole       = document.getElementById('frontRole');
    const frontIdNumber   = document.getElementById('frontIdNumber');
    const idPhoto         = document.getElementById('idPhoto');
    const sigImg          = document.getElementById('sigImg');
    const barcodeSvg      = document.getElementById('barcode');
    const cardStatusBadge = document.getElementById('cardStatusBadge');

    // BACK FIELDS
    const backAddress     = document.getElementById('backAddress');
    const backContact     = document.getElementById('backContact');
    const backPrecinct    = document.getElementById('backPrecinct');
    const backRole        = document.getElementById('backRole');

    // theme widgets
    const templateSelect  = document.getElementById('templateSelect');
    const themePreviewText= document.getElementById('themePreviewText');

    let currentResidentId = null;

    function applyTemplate() {
      const design = templateSelect ? (templateSelect.value || 'A') : 'A';
      const frontCard = document.getElementById('idFront');
      const backCard  = document.getElementById('idBack');
      if(!frontCard || !backCard) return;

      frontCard.classList.add('fade-out');
      backCard.classList.add('fade-out');

      setTimeout(() => {
        frontCard.classList.remove('themeAFront','themeBFront','themeCFront','themeDFront','themeEFront','themeFront','themeGFront','themeHFront');
        backCard.classList.remove('themeABack','themeBBack','themeCBack','themeDBack','themeEBack','themeFBack','themeGBack','themeHBack');

        if (design === 'A') {
          frontCard.classList.add('themeAFront');
          backCard.classList.add('themeABack');
          if(themePreviewText) themePreviewText.textContent = "Currently: Theme A â€“ Yellow (Official)";
        } else if (design === 'B') {
          frontCard.classList.add('themeBFront');
          backCard.classList.add('themeBBack');
          if(themePreviewText) themePreviewText.textContent = "Currently: Theme B â€“ Blue (Alternate)";
        } else if (design === 'C') {
          frontCard.classList.add('themeCFront');
          backCard.classList.add('themeCBack');
          if(themePreviewText) themePreviewText.textContent = "Currently: Theme C â€“ Black & Gold (Modern)";
        } else if (design === 'D') {
          frontCard.classList.add('themeDFront');
          backCard.classList.add('themeDBack');
          if(themePreviewText) themePreviewText.textContent = "Currently: Theme D â€“ Green (Nature)";
        } else if (design === 'E') {
          frontCard.classList.add('themeEFront');
          backCard.classList.add('themeEBack');
          if(themePreviewText) themePreviewText.textContent = "Currently: Theme E â€“ Red (Heritage)";
        } else if (design === 'F') {
          frontCard.classList.add('themeFront');
          backCard.classList.add('themeFBack');
          if(themePreviewText) themePreviewText.textContent = "Currently: Theme F â€“ Purple (Modern)";
        } else if (design === 'G') {
          frontCard.classList.add('themeGFront');
          backCard.classList.add('themeGBack');
          if(themePreviewText) themePreviewText.textContent = "Currently: Theme G â€“ Orange (Sunset)";
        } else if (design === 'H') {
          frontCard.classList.add('themeHFront');
          backCard.classList.add('themeHBack');
          if(themePreviewText) themePreviewText.textContent = "Currently: Theme H â€“ Teal (Ocean)";
        }

        localStorage.setItem('selectedTheme', design);

        frontCard.classList.remove('fade-out');
        backCard.classList.remove('fade-out');
        frontCard.classList.add('fade-in');
        backCard.classList.add('fade-in');

        setTimeout(()=>{
          frontCard.classList.remove('fade-in');
          backCard.classList.remove('fade-in');
        },400);
      },200);
    }

    function toggleEditMode(enabled) {
      const editableFields = document.querySelectorAll('.editable-field');
      const statusEl = document.getElementById('editModeStatus');
      const photoOverlay = document.getElementById('photoEditOverlay');
      const signatureOverlay = document.getElementById('signatureEditOverlay');
      const chairwomanOverlay = document.getElementById('chairwomanEditOverlay');
      
      editableFields.forEach(field => {
        field.contentEditable = enabled;
        if (enabled) {
          field.classList.add('edit-enabled');
          field.title = 'Click to edit this field';
        } else {
          field.classList.remove('edit-enabled');
          field.title = '';
        }
      });

      // Show/hide image edit overlays
      if (photoOverlay) {
        photoOverlay.style.display = enabled ? 'flex' : 'none';
      }
      if (signatureOverlay) {
        signatureOverlay.style.display = enabled ? 'flex' : 'none';
      }
      if (chairwomanOverlay) {
        chairwomanOverlay.style.display = enabled ? 'flex' : 'none';
      }

      if (statusEl) {
        statusEl.textContent = enabled ? 'Enabled' : 'Disabled';
        statusEl.style.color = enabled ? '#059669' : '#9ca3af';
      }
    }

    // Photo and Signature Edit Functions
    function setupImageEditHandlers() {
      const changePhotoBtn = document.getElementById('changePhotoBtn');
      const deletePhotoBtn = document.getElementById('deletePhotoBtn');
      const photoFileInput = document.getElementById('photoFileInput');
      const changeSignatureBtn = document.getElementById('changeSignatureBtn');
      const deleteSignatureBtn = document.getElementById('deleteSignatureBtn');
      const signatureFileInput = document.getElementById('signatureFileInput');
      const changeChairwomanBtn = document.getElementById('changeChairwomanBtn');
      const deleteChairwomanBtn = document.getElementById('deleteChairwomanBtn');
      const chairwomanFileInput = document.getElementById('chairwomanFileInput');
      const idPhoto = document.getElementById('idPhoto');
      const sigImg = document.getElementById('sigImg');
      const chairwomanImg = document.getElementById('chairwomanImg');

      // Photo handlers
      if (changePhotoBtn && photoFileInput) {
        changePhotoBtn.addEventListener('click', () => {
          photoFileInput.click();
        });

        photoFileInput.addEventListener('change', (e) => {
          const file = e.target.files[0];
          if (file) {
            const reader = new FileReader();
            reader.onload = (event) => {
              if (idPhoto) {
                idPhoto.src = event.target.result;
              }
            };
            reader.readAsDataURL(file);
          }
        });
      }

      if (deletePhotoBtn && idPhoto) {
        deletePhotoBtn.addEventListener('click', () => {
          if (confirm('Delete photo?')) {
            idPhoto.src = '';
          }
        });
      }

      // Signature handlers
      if (changeSignatureBtn && signatureFileInput) {
        changeSignatureBtn.addEventListener('click', () => {
          signatureFileInput.click();
        });

        signatureFileInput.addEventListener('change', (e) => {
          const file = e.target.files[0];
          if (file) {
            const reader = new FileReader();
            reader.onload = (event) => {
              if (sigImg) {
                sigImg.src = event.target.result;
              }
            };
            reader.readAsDataURL(file);
          }
        });
      }

      if (deleteSignatureBtn && sigImg) {
        deleteSignatureBtn.addEventListener('click', () => {
          if (confirm('Delete signature?')) {
            sigImg.src = '';
          }
        });
      }

      // Chairwoman handlers
      if (changeChairwomanBtn && chairwomanFileInput) {
        changeChairwomanBtn.addEventListener('click', () => {
          chairwomanFileInput.click();
        });

        chairwomanFileInput.addEventListener('change', (e) => {
          const file = e.target.files[0];
          if (file) {
            const reader = new FileReader();
            reader.onload = (event) => {
              if (chairwomanImg) {
                chairwomanImg.src = event.target.result;
              }
            };
            reader.readAsDataURL(file);
          }
        });
      }

      if (deleteChairwomanBtn && chairwomanImg) {
        deleteChairwomanBtn.addEventListener('click', () => {
          if (confirm('Delete chairwoman signature?')) {
            chairwomanImg.src = '';
          }
        });
      }
    }

    window.addEventListener('DOMContentLoaded', ()=>{
      const saved = localStorage.getItem('selectedTheme');
      if (saved && templateSelect) {
        templateSelect.value = saved;
      }
      applyTemplate();
      setupImageEditHandlers();
    });

    templateSelect?.addEventListener('change', applyTemplate);

    const editModeToggle = document.getElementById('editModeToggle');
    editModeToggle?.addEventListener('change', function() {
      toggleEditMode(this.checked);
    });

    async function loadToID(id){
      try {
        const r = await ResidentService.getById(id);
        if(!r) return;

        currentResidentId = id;
      showPage('idgen');

      // FRONT fill - using new schema properties
      if(frontFullName)  frontFullName.textContent = r.fullName || r.name || 'â€”';
      if(frontRole)      frontRole.textContent     = (r.purokOrPosition || r.purok || 'RESIDENT').toUpperCase();
      if(frontIdNumber)  frontIdNumber.textContent = r.idNumber || r.idno || 'â€”';
      if(idPhoto)        idPhoto.src               = r.photoUrl || r.photo || '';
      if(sigImg)         sigImg.src                = r.signatureUrl || r.signature || '';

      // BACK fill - using new schema properties
      if(backAddress)    backAddress.textContent   = r.address  || 'â€”';
      if(backContact)    backContact.textContent   = r.contact  || 'â€”';
      if(backPrecinct)   backPrecinct.textContent  = r.precinctNumber || r.household || 'â€”';
      if(backRole)       backRole.textContent      = (r.purokOrPosition || r.purok || 'RESIDENT').toUpperCase();

      // STATUS badge
      if(cardStatusBadge){
        if(r.status === 'released'){
          cardStatusBadge.textContent = 'Released';
          cardStatusBadge.className = 'tag green';
        } else {
          cardStatusBadge.textContent = 'Pending';
          cardStatusBadge.className = 'tag red';
        }
      }

      // barcode
      if(typeof JsBarcode === "function" && barcodeSvg){
        JsBarcode(barcodeSvg, r.idNumber || r.idno || "N/A", {
          format:'CODE128',
          width:1.4,
          height:40,
          displayValue:false
        });
      }

      applyTemplate();
      
      // Initialize edit mode based on toggle state
      const editModeToggle = document.getElementById('editModeToggle');
      if (editModeToggle) {
        toggleEditMode(editModeToggle.checked);
      }
      } catch (error) {
        console.error('Error loading resident to ID:', error);
        alert('Failed to load resident: ' + error.message);
      }
    }

    window.loadToID = loadToID;
    window.removeResident = removeResident;
    window.openEdit = openEdit;

    // Mark Pending / Released
    const btnPending = document.getElementById('btnPending');
    const btnReleased = document.getElementById('btnReleased');

    btnPending.onclick = async ()=>{
      if(!requireStaff()||!currentResidentId) return;
      try {
        await ResidentService.updateStatus(currentResidentId, 'Pending');
        const r = await ResidentService.getById(currentResidentId);
        await audit('id:mark-pending',{idno: r.idNumber || r.idno});

        if(cardStatusBadge){
          cardStatusBadge.textContent = 'Pending';
          cardStatusBadge.className = 'tag red';
        }

        renderResidents();
      } catch (error) {
        console.error('Error marking as pending:', error);
        alert('Failed to update status: ' + error.message);
      }
    };

    btnReleased.onclick = async ()=>{
      if(!requireStaff()||!currentResidentId) return;
      try {
        await ResidentService.updateStatus(currentResidentId, 'Released');
        const r = await ResidentService.getById(currentResidentId);
        await audit('id:mark-released',{
          idno: r.idNumber || r.idno,
          releasedAt: new Date().toISOString()
        });

        if(cardStatusBadge){
          cardStatusBadge.textContent = 'Released';
          cardStatusBadge.className = 'tag green';
        }

        renderResidents();
      } catch (error) {
        console.error('Error marking as released:', error);
        alert('Failed to update status: ' + error.message);
      }
    };

    /************* PVC PRINT SUPPORT *************/
    function syncCardToPrintWrappers() {
      const liveFront = document.getElementById('idFront');
      const liveBack  = document.getElementById('idBack');

      const printFrontCard = document.getElementById('printFrontCard');
      const printBackCard  = document.getElementById('printBackCard');

      if (liveFront && printFrontCard) {
        printFrontCard.className = liveFront.className;
        printFrontCard.innerHTML = liveFront.innerHTML;
      }
      if (liveBack && printBackCard) {
        printBackCard.className = liveBack.className;
        printBackCard.innerHTML = liveBack.innerHTML;
      }
    }

    function printPVC(which){
      if(!currentResidentId){
        alert('Please select a resident first before printing.\n\nTo print an ID card:\n1. Go to the "Residents" tab\n2. Click "Generate ID" on any resident\n3. Then return here to print the PVC card');
        return;
      }

      // Show printing status
      const printingSide = which === 'front' ? 'Front' : 'Back';
      console.log(`ðŸ–¨ï¸ Preparing to print PVC ${printingSide} card...`);

      syncCardToPrintWrappers();

      const frontWrap = document.getElementById('printFrontWrapper');
      const backWrap  = document.getElementById('printBackWrapper');

      frontWrap.classList.remove('printing-now');
      backWrap.classList.remove('printing-now');

      if(which === 'front'){
        frontWrap.classList.add('printing-now');
      } else {
        backWrap.classList.add('printing-now');
      }

      frontWrap.classList.remove('hidden');
      backWrap.classList.remove('hidden');

      // Brief delay to ensure content is synced
      setTimeout(() => {
        window.print();
        console.log(`âœ… Print dialog opened for PVC ${printingSide} card`);
        
        // Clean up after print
        setTimeout(() => {
          frontWrap.classList.add('hidden');
          backWrap.classList.add('hidden');
          frontWrap.classList.remove('printing-now');
          backWrap.classList.remove('printing-now');
        }, 100);
      }, 50);
    }

    const btnPrintPVCFront = document.getElementById('btnPrintPVCFront');
    const btnPrintPVCBack  = document.getElementById('btnPrintPVCBack');

    btnPrintPVCFront?.addEventListener('click', ()=>printPVC('front'));
    btnPrintPVCBack?.addEventListener('click',  ()=>printPVC('back'));

    const btnReprint = document.getElementById('btnReprint');
    btnReprint.onclick = ()=>{
      if(!currentResidentId){
        alert('Open a resident in ID Generator first.');
        return;
      }
      printPVC('front');
    };

    // Search in IDGen sidebar
    const searchInput = document.getElementById('searchId');
    const searchResults = document.getElementById('searchResults');
    searchInput?.addEventListener('input', async ()=>{
      const q = searchInput.value.trim().toLowerCase();
      if(!q){
        searchResults.innerHTML='';
        return;
      }
      try {
        const list = await ResidentService.getAll();
        const matches = list.filter(r=>
          (r.idNumber && r.idNumber.toLowerCase().includes(q)) ||
          (r.fullName && r.fullName.toLowerCase().includes(q))
        );

        if(matches.length===0){
          searchResults.innerHTML = `<span class="muted">No match</span>`;
          return;
        }

        searchResults.innerHTML = matches.slice(0,8).map(r=>`
          <div>
            <a href="#" data-id="${r.id}" class="pickPerson">
              ${r.idNumber || 'â€”'} â€” ${r.fullName || 'Unknown'}
            </a>
          </div>
        `).join('');

        searchResults.querySelectorAll('.pickPerson').forEach(a=>{
          a.addEventListener('click', (ev)=>{
            ev.preventDefault();
            const rid = a.getAttribute('data-id');
            loadToID(rid);
          });
        });
      } catch (error) {
        console.error('âŒ Search error:', error);
        searchResults.innerHTML = `<span class="muted">Search error</span>`;
      }
    });

    /************* E-Docs *************/
    const reqForm = document.getElementById('reqForm');
    const reqTable = document.getElementById('reqTable');

    reqForm?.addEventListener('submit', async (e)=>{
      e.preventDefault();
      try {
        const residentIdNumber = document.getElementById('reqId').value.trim();
        const docType = document.getElementById('reqDoc').value;
        const purpose = document.getElementById('reqPurpose').value.trim();

        if (!residentIdNumber) {
          alert('Please enter Resident ID Number');
          return;
        }

        await RequestService.create({
          residentIdNumber,
          docType,
          purpose
        });

        console.log('âœ… Document request submitted');
        reqForm.reset();
        await renderReqs();
        await updateDashboardStats();
      } catch (error) {
        console.error('âŒ Failed to submit request:', error);
        alert(`Failed to submit request: ${error.message}`);
      }
    });

    async function renderReqs(){
      try {
        const rows = await RequestService.getAll();
        rows.sort((a,b)=> new Date(b.createdAt) - new Date(a.createdAt));

        const reqTable = document.getElementById('reqTable');
        if (!reqTable) return;

        reqTable.innerHTML = rows.map(x=>{
          const tagClass =
            x.status==='Released' ? 'green' :
            x.status==='Approved' ? 'amber' : 'red';

          return `<tr>
            <td>${x.residentIdNumber||''}</td>
            <td>${x.docType||x.doc||''}</td>
            <td>${x.purpose||''}</td>
            <td><span class="tag ${tagClass}">${x.status}</span></td>
            <td>
              <button class='btn ghost' data-rid="${x.id}" data-status="Approved">Approve</button>
              <button class='btn' data-rid="${x.id}" data-status="Released">Release</button>
            </td>
          </tr>`;
        }).join('');

        reqTable.querySelectorAll('button').forEach(btn=>{
          btn.addEventListener('click',()=>{
            const rid = parseInt(btn.getAttribute('data-rid'),10);
            const status = btn.getAttribute('data-status');
            setReqStatus(rid,status);
          });
        });

        console.log('âœ… Requests rendered:', rows.length);
      } catch (error) {
        console.error('âŒ Failed to render requests:', error);
      }
    }

    async function setReqStatus(rid,status){
      if(!requireStaff()) return;
      try {
        await RequestService.updateStatus(rid, status);
        console.log('âœ… Request status updated:', rid, status);
        await renderReqs();
        await updateDashboardStats();
      } catch (error) {
        console.error('âŒ Failed to update request status:', error);
        alert(`Failed to update status: ${error.message}`);
      }
    }

    /************* Complaints *************/
    const cmpForm = document.getElementById('cmpForm');
    const cmpTable = document.getElementById('cmpTable');

    cmpForm?.addEventListener('submit', async (e)=>{
      e.preventDefault();
      try {
        const residentIdNumber = document.getElementById('cmpId').value.trim();
        const details = document.getElementById('cmpText').value.trim();

        if (!details) {
          alert('Please enter complaint details');
          return;
        }

        await ComplaintService.create({
          residentIdNumber,
          details
        });

        console.log('âœ… Complaint submitted');
        cmpForm.reset();
        await renderComplaints();
        await updateDashboardStats();
      } catch (error) {
        console.error('âŒ Failed to submit complaint:', error);
        alert(`Failed to submit complaint: ${error.message}`);
      }
    });

    async function renderComplaints(){
      try {
        const rows = await ComplaintService.getAll();
        rows.sort((a,b)=> new Date(b.ts) - new Date(a.ts));

        const cmpTable = document.getElementById('cmpTable');
        if (!cmpTable) return;

        cmpTable.innerHTML = rows.map(x=>`
          <tr>
            <td>${x.residentIdNumber||'â€”'}</td>
            <td>${x.details||x.text||''}</td>
            <td>${new Date(x.ts).toLocaleString()}</td>
          </tr>
        `).join('');

        console.log('âœ… Complaints rendered:', rows.length);
      } catch (error) {
        console.error('âŒ Failed to render complaints:', error);
      }
    }

    /************* Router (navigation tabs) *************/
    const sections = [
      'dashboard','residents','idgen','edocs','complaints','reports','settings'
    ];
    
    // Define showPage function FIRST (before using it)
    function showPage(id){
      if (!id) {
        console.error('âŒ showPage called with invalid id:', id);
        return;
      }
      
      if (!sections.includes(id)) {
        console.error('âŒ Unknown page id:', id, '| Valid pages:', sections);
        return;
      }
      
      console.log('ðŸ”„ Navigating to page:', id);
      
      // Hide all sections, show only the target section
      sections.forEach(s=>{
        const pageId = 'page-' + s;
        const sec = document.getElementById(pageId);
        
        if (sec) {
          if (s === id) {
            // Show this section
            sec.classList.remove('hidden');
            sec.setAttribute('aria-hidden', 'false');
            sec.style.display = ''; // Clear any inline display style
            console.log('âœ… Showing section:', pageId);
          } else {
            // Hide other sections
            sec.classList.add('hidden');
            sec.setAttribute('aria-hidden', 'true');
          }
        } else {
          console.error('âŒ Section not found in DOM:', pageId);
        }
      });

      // Update active state on all navigation buttons
      const allNavButtons = document.querySelectorAll('button[data-page]');
      console.log('ðŸ“ Found', allNavButtons.length, 'navigation buttons');
      
      allNavButtons.forEach(b => {
        if (b.dataset.page === id) {
          b.classList.add('active');
          b.setAttribute('aria-current', 'page');
        } else {
          b.classList.remove('active');
          b.removeAttribute('aria-current');
        }
      });
      
      // Scroll to top of page for better UX
      window.scrollTo({ top: 0, behavior: 'smooth' });
      
      console.log('âœ… Navigation complete to:', id);
    }
    
    // Expose globally IMMEDIATELY after defining
    window.navigateTo = showPage;
    console.log('âœ… Navigation system initialized. Use window.navigateTo(pageName) to navigate.');
    console.log('ðŸ“‹ Available pages:', sections);
    
    // Test function to verify all pages exist
    window.testNavigation = function() {
      console.log('ðŸ§ª Testing navigation system...');
      sections.forEach(s => {
        const elem = document.getElementById('page-' + s);
        console.log(`  ${elem ? 'âœ…' : 'âŒ'} page-${s}:`, elem ? 'Found' : 'NOT FOUND');
      });
    };
    
    // Now set up event listeners
    const nav = document.getElementById('topnav');
    if (nav) {
      nav.addEventListener('click', (e)=>{
        // Check if we clicked on a button or inside a button (including SVG/span children)
        const btn = e.target.closest('button[data-page]');
        if (!btn) {
          console.log('ðŸ” Click not on a navigation button');
          return; // Only handle buttons with data-page attribute
        }
        
        const pageId = btn.dataset.page;
        console.log('ðŸ–±ï¸ Navigation button clicked:', pageId);
        
        if (pageId && sections.includes(pageId)) {
          e.preventDefault(); // Prevent default button behavior
          e.stopPropagation(); // Stop event from bubbling
          
          showPage(pageId);
          
          // Close mobile menu after navigation
          if (nav.classList.contains('nav-mobile-open')) {
            console.log('ðŸ“± Closing mobile menu after navigation');
            nav.classList.remove('nav-mobile-open');
            const hamburgerBtn = document.getElementById('navToggle');
            if (hamburgerBtn) {
              hamburgerBtn.classList.remove('active');
              hamburgerBtn.setAttribute('aria-expanded', 'false');
            }
            document.body.style.overflow = ''; // Re-enable scrolling
          }
        } else {
          console.error('âŒ Invalid page ID:', pageId);
        }
      });
      console.log('âœ… Navigation click handler attached to #topnav');
    } else {
      console.error('âŒ Navigation element #topnav not found!');
    }

    /************* Hamburger Menu Toggle *************/
    const hamburgerBtn = document.getElementById('navToggle');
    if (hamburgerBtn && nav) {
      hamburgerBtn.addEventListener('click', (e) => {
        e.preventDefault();
        e.stopPropagation();
        
        const isOpen = nav.classList.contains('nav-mobile-open');
        
        if (isOpen) {
          // Close menu
          console.log('ðŸ“± Closing mobile menu (hamburger clicked)');
          nav.classList.remove('nav-mobile-open');
          hamburgerBtn.classList.remove('active');
          hamburgerBtn.setAttribute('aria-expanded', 'false');
          document.body.style.overflow = ''; // Re-enable scrolling
        } else {
          // Open menu
          console.log('ðŸ“± Opening mobile menu (hamburger clicked)');
          nav.classList.add('nav-mobile-open');
          hamburgerBtn.classList.add('active');
          hamburgerBtn.setAttribute('aria-expanded', 'true');
          document.body.style.overflow = 'hidden'; // Prevent background scrolling
        }
      });
      
      // Close menu when clicking the overlay background (NOT on buttons)
      nav.addEventListener('click', (e) => {
        // Only close if clicking directly on nav (the overlay), not on buttons or their children
        if (e.target === nav) {
          console.log('ðŸ“± Closing mobile menu (overlay clicked)');
          nav.classList.remove('nav-mobile-open');
          hamburgerBtn.classList.remove('active');
          hamburgerBtn.setAttribute('aria-expanded', 'false');
          document.body.style.overflow = '';
        }
        
        // Close button area (top-right corner)
        if (nav.classList.contains('nav-mobile-open') && 
            e.clientX > window.innerWidth - 80 && e.clientY < 80) {
          console.log('ðŸ“± Closing mobile menu (close button clicked)');
          nav.classList.remove('nav-mobile-open');
          hamburgerBtn.classList.remove('active');
          hamburgerBtn.setAttribute('aria-expanded', 'false');
          document.body.style.overflow = '';
        }
      });
      
      // Close menu on ESC key
      document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape' && nav.classList.contains('nav-mobile-open')) {
          console.log('ðŸ“± Closing mobile menu (ESC key pressed)');
          nav.classList.remove('nav-mobile-open');
          hamburgerBtn.classList.remove('active');
          hamburgerBtn.setAttribute('aria-expanded', 'false');
          document.body.style.overflow = '';
        }
      });
      
      console.log('âœ… Hamburger menu functionality initialized');
    }

    /************* Header Scroll Effect *************/
    let lastScrollTop = 0;
    window.addEventListener('scroll', () => {
      const header = document.querySelector('header.system-header');
      if (!header) return;
      
      const scrollTop = window.pageYOffset || document.documentElement.scrollTop;
      
      if (scrollTop > 10) {
        header.classList.add('scrolled');
      } else {
        header.classList.remove('scrolled');
      }
      
      lastScrollTop = scrollTop;
    });

    /************* Dashboard Stats & Audit *************/
    /**
     * Update all dashboard statistics from backend API
     * Fetches real-time data for residents, complaints, events, and requests
     */
    async function updateDashboardStats(){
      try {
        // Fetch all statistics from backend
        const [residentStats, complaintStats, requestStats, eventStats] = await Promise.all([
          ResidentService.getStats(),
          ComplaintService.getStats().catch(() => ({ total: 0 })),
          RequestService.getStats().catch(() => ({ total: 0 })),
          EventService.getStats().catch(() => ({ total: 0, upcoming: 0 }))
        ]);

        // Update Residents Card (#statResidents)
        const statResidentsNum = document.querySelector('#statResidents .stat-number');
        if (statResidentsNum) statResidentsNum.textContent = residentStats.total;
        
        // Update Residents List Card (#statResidentsCount)
        const statResidentsCountNum = document.querySelector('#statResidentsCount');
        if (statResidentsCountNum) statResidentsCountNum.textContent = residentStats.total;
        
        // Update ID Status Card (#statPending)
        const statPendingNum = document.querySelector('#statPending .stat-number');
        if (statPendingNum) statPendingNum.textContent = residentStats.pending;
        
        // Update Documents Card (#statReleased)
        const statReleasedNum = document.querySelector('#statReleased .stat-number');
        if (statReleasedNum) statReleasedNum.textContent = residentStats.released;
        
        // Update Complaints Card (NEW - was missing before)
        const statComplaintsNum = document.querySelectorAll('.dashboard-stat-card')[4]?.querySelector('.stat-number');
        if (statComplaintsNum) statComplaintsNum.textContent = complaintStats.total;
        
        // Update Events Card (NEW - was missing before)
        const statEventsNum = document.querySelectorAll('.dashboard-stat-card')[5]?.querySelector('.stat-number');
        if (statEventsNum) statEventsNum.textContent = eventStats.upcoming;

        console.log('ðŸ“Š Dashboard stats updated:', {
          residents: residentStats.total,
          pending: residentStats.pending,
          released: residentStats.released,
          complaints: complaintStats.total,
          events: eventStats.upcoming
        });
      } catch (error) {
        console.error('âŒ Failed to update dashboard stats:', error);
      }
    }
    
    /**
     * Legacy function for backward compatibility
     * Now calls updateDashboardStats() instead
     */
    function updateStats(list){
      updateDashboardStats();
    }

    async function renderAudit(){
      try {
        const logs = await AuditService.getRecent(12);
        
        const auditLatest = document.getElementById('auditLatest');
        if (!auditLatest) return;
        
        auditLatest.innerHTML = logs.map(l=>{
          const when = new Date(l.ts).toLocaleString();
          return `<div class='mb8' style="font-size:13px;line-height:1.4;">
            <b>${l.action}</b><br>
            <span class='muted'>${when} â€¢ ${l.byUser || 'System'}</span>
          </div>`;
        }).join('');
        
        console.log('ðŸ“‹ Audit log rendered:', logs.length, 'entries');
      } catch (error) {
        console.error('âŒ Failed to render audit log:', error);
      }
    }

    /************* AI Face Detection & Matching *************/
    const cam=document.getElementById('cam');
    const overlay=document.getElementById('overlay');
    const startBtn=document.getElementById('btnStartCam');
    const captureBtn=document.getElementById('btnCapture');
    const veriStatus=document.getElementById('veriStatus');
    let modelsLoaded=false;

    async function loadModels(){
      if(modelsLoaded) return;
      const url='https://cdn.jsdelivr.net/npm/face-api.js@0.22.2/weights';
      await faceapi.nets.tinyFaceDetector.loadFromUri(url);
      await faceapi.nets.faceRecognitionNet.loadFromUri(url);
      await faceapi.nets.faceLandmark68Net.loadFromUri(url);
      modelsLoaded=true;
    }

    startBtn.onclick = async ()=>{
      await loadModels();
      const stream = await navigator.mediaDevices.getUserMedia({video:true});
      cam.srcObject=stream;
      veriStatus.textContent='Camera on';
      veriStatus.className='tag amber';
    };

    captureBtn.onclick = async ()=>{
      if(!currentResidentId){
        alert('Open a resident in ID Generator first.');
        return;
      }
      await loadModels();
      veriStatus.textContent='Detectingâ€¦';
      veriStatus.className='tag amber';

      try {
        const r = await ResidentService.getById(currentResidentId);
        if(!r || !r.photo){
          alert('Resident has no reference photo');
          return;
        }

      const refImg = await faceapi.fetchImage(r.photo);
      const refDet = await faceapi
        .detectSingleFace(refImg, new faceapi.TinyFaceDetectorOptions())
        .withFaceLandmarks()
        .withFaceDescriptor();

      if(!refDet){
        veriStatus.textContent='No face in stored photo';
        veriStatus.className='tag red';
        await audit('verify:fail',{idno:r.idno, reason:'no face in stored'});
        return;
      }

      const c=document.createElement('canvas');
      c.width=cam.videoWidth;
      c.height=cam.videoHeight;
      c.getContext('2d').drawImage(cam,0,0);

      const det = await faceapi
        .detectSingleFace(c, new faceapi.TinyFaceDetectorOptions())
        .withFaceLandmarks()
        .withFaceDescriptor();

      const ctx=overlay.getContext('2d');
      ctx.clearRect(0,0,overlay.width,overlay.height);

      if(det?.detection){
        const {x,y,width,height}=det.detection.box;
        const sx=overlay.width/c.width;
        const sy=overlay.height/c.height;
        ctx.strokeStyle='#22c55e';
        ctx.lineWidth=2;
        ctx.strokeRect(x*sx,y*sy,width*sx,height*sy);
      }

      if(!det){
        veriStatus.textContent='No human face detected';
        veriStatus.className='tag red';
        await audit('verify:fail',{idno:r.idno, reason:'no face live'});
        return;
      }

      const dist = faceapi.euclideanDistance(refDet.descriptor, det.descriptor);
      const pass = dist <= 0.5;

      veriStatus.textContent = pass
        ? `Matched (distance ${dist.toFixed(3)})`
        : `Not match (${dist.toFixed(3)})`;

      veriStatus.className = pass? 'tag green' : 'tag red';

      await audit(pass?'verify:pass':'verify:fail', {idno:r.idno, dist});
      } catch (error) {
        console.error('Error in face verification:', error);
        veriStatus.textContent='Verification error';
        veriStatus.className='tag red';
      }
    };

    /************* INIT *************/
    (async function init(){
      console.log('ðŸš€ Initializing Digital ID System...');
      console.log('ðŸ“¡ Using SQLite Backend (Clean Architecture)');
      
      try {
        // Load all data from backend API
        await renderResidents();
        await renderReqs();
        await renderComplaints();
        await renderAudit();
        await updateDashboardStats();
        
        // Initialize navigation - show dashboard by default
        showPage('dashboard');
        console.log('âœ… App initialized successfully!');
      } catch (error) {
        console.error('âŒ Initialization error:', error);
        alert('Failed to connect to backend server. Please ensure the server is running on http://localhost:3000');
      }
    })();
  </script>

  <!-- RESPONSIVE: Hamburger Menu Toggle - REMOVED DUPLICATE (handled in main script above) -->

</body>
</html>
